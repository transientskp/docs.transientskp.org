<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Source Association Logic &mdash; LOFAR Transients Pipeline 2.0-pre documentation</title>
    
    <link rel="stylesheet" href="../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0-pre',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../_static/lofar.ico"/>
    <link rel="top" title="LOFAR Transients Pipeline 2.0-pre documentation" href="../../index.html" />
    <link rel="up" title="Overview of the TKP Database" href="index.html" />
    <link rel="next" title="HOWTO" href="howto.html" />
    <link rel="prev" title="Schema" href="schema.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="howto.html" title="HOWTO"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="schema.html" title="Schema"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">LOFAR Transients Pipeline 2.0-pre documentation</a> &raquo;</li>
          <li><a href="../index.html" >Developer&#8217;s Reference Guide</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Overview of the TKP Database</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="source-association-logic">
<span id="database-assoc"></span><h1>Source Association Logic<a class="headerlink" href="#source-association-logic" title="Permalink to this headline">¶</a></h1>
<p>Source association—the process by which individual measurements recorded from
an image corresponding to a given time, frequency and Stokes parameter are
combined to form a lightcurve representing an astronomical source—is
fundamental to the goals of the Transients KSP. However, the process is
complex and may be counterintuitive. A thorough understanding is essential
both to enable end-users to interpret pipeline results and to inform pipeline
design decisions.</p>
<p>Here, we summarise the various possible results of source association,
highlighting potential issues. For a full discussion of the algorithms
involved, the user is referred to <a class="reference internal" href="../../bibliography.html#scheers-2011"><em>Scheers (2011)</em></a>.</p>
<div class="section" id="database-structure-association-procedure">
<h2>Database Structure &amp; Association Procedure<a class="headerlink" href="#database-structure-association-procedure" title="Permalink to this headline">¶</a></h2>
<p>The structure of the database is discussed in detail <a class="reference internal" href="schema.html#database-schema"><em>elsewhere</em></a>: here, only a brief overview of the relevant tables is
presented.</p>
<p>Each measurement (that is, a set of coordinates, a shape, and a flux) taken is
inserted into the <tt class="docutils literal"><span class="pre">extractedsource</span></tt> table. Many such measurements may be
taken from a single image, either due to &#8220;blind&#8221; source finding (that is,
automatically attempting to locate islands of significant bright pixels), or
by a user-requested fit to a specific position.</p>
<p>The association procedure knits together (&#8220;associates&#8221;) the measurements in
<tt class="docutils literal"><span class="pre">extractedsource</span></tt> which are believed to originate from a single
astronomical source. Each such source is given an entry in the
<tt class="docutils literal"><span class="pre">runningcatalog</span></tt> table which ties together all of the measurements by means
of the <tt class="docutils literal"><span class="pre">assocxtrsource</span></tt> table. Thus, an entry in <tt class="docutils literal"><span class="pre">runningcatalog</span></tt> can be
thought of as a reference to the lightcurve of a particular source.</p>
<p>Each lightcurve may be composed of measurements in one or more frequency bands
(as defined in the <tt class="docutils literal"><span class="pre">frequencyband</span></tt> table). Within each band flux
measurements are collated. These include the average flux of the source in
that band, as well as assorted measures of variability. Each row in the
<tt class="docutils literal"><span class="pre">runningcatalog_flux</span></tt> table contains flux statistics of this sort for a
given band of a given flux. Thus, each row in <tt class="docutils literal"><span class="pre">runningcatalog</span></tt> may be
associated with both multiple rows in <tt class="docutils literal"><span class="pre">extractedsource</span></tt> and in
<tt class="docutils literal"><span class="pre">runningcatalog_flux</span></tt>.  Bear in mind, however, that each lightcurve has a
<em>single</em> average position associated with it, stored in the <tt class="docutils literal"><span class="pre">runningcatalog</span></tt>
table.</p>
<p>When a new source measurement is made, the association procedure compares it
against the records in <tt class="docutils literal"><span class="pre">runningcatalog</span></tt>. Note that the comparison is based
upon position <em>only</em>: an association is made if the new measurement is a good
fit with a position in <tt class="docutils literal"><span class="pre">runningcatalog</span></tt>, regardless of the time or frequency
associated with it. After the association has been made, the position recorded
for the source in <tt class="docutils literal"><span class="pre">runningcatalog</span></tt> is updated to take account of the new
measurement.</p>
<p>It is important to note that source association must as far as possible be
<em>commutative</em>. That is, given a set of measurements, the final contents of the
database should not be dependent upon the order of their insertion. This is
not possible in the general case—it would involve a quadratic number of
source comparisons—but source association procedures should be designed with
this goal in mind. In particular, we require that source association be
commutative if all measurements made at time <span class="math">\(t_n\)</span> are inserted and
associated before any measurements made at time <span class="math">\(t_{n+1}\)</span>.</p>
<div class="section" id="case-studies">
<h3>Case Studies<a class="headerlink" href="#case-studies" title="Permalink to this headline">¶</a></h3>
<p>Here we will discuss the various outcomes which are possible from the source
association process under different conditions. In the following, individual
timesteps are indicated by the notation <span class="math">\(t_i\)</span> and individual flux measurements
(that is, at a particular time/band/Stokes) by <span class="math">\(f_j\)</span>. Lightcurves (entries in
<tt class="docutils literal"><span class="pre">runningcatalog</span></tt>) are indicated by <span class="math">\(L_k\)</span>; the flux measurements which
constitute a particular lightcurve are linked to the <span class="math">\(L_k\)</span> symbol by means of a
coloured line.</p>
<div class="section" id="single-frequency-band">
<h4>Single Frequency Band<a class="headerlink" href="#single-frequency-band" title="Permalink to this headline">¶</a></h4>
<p>We start by considering observations with only a single frequency band.</p>
<div class="section" id="one-to-one-association">
<h5>One-to-One Association<a class="headerlink" href="#one-to-one-association" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-64adeb6104bdda21dea5cc6cf25d8d6fd5036ae2.png" alt="digraph one2one {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f1 -&gt; f2 -&gt; f3 -&gt; f4 [color=blue];
    node[shape=box, color=red];
    l1 [label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f4 -&gt; l1 [style=dashed, color=blue];
    node[shape=none];
    edge[style=invis];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>In this simplest case all the flux measurements are unambiguously associated
in order. A single lightcurve is generated. The calculated average flux of the
lightcurve <span class="math">\(L_1\)</span> is <span class="math">\(\overline{f_{1\cdots{}4}}\)</span>.</p>
</div>
<div class="section" id="one-to-many-association">
<h5>One-to-Many Association<a class="headerlink" href="#one-to-many-association" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-0393bf0d654dc3d6ad9dc5493736a935ab8445c4.png" alt="digraph one2many {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f1 -&gt; f2 -&gt; f3 -&gt; f5 [color=blue];
    f1 -&gt; f2 -&gt; f4 -&gt; f6 [color=green];
    node[shape=box, color=red];
    l1 [label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    l2 [label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f5 -&gt; l1 [color=blue, style=dashed];
    f6 -&gt; l2 [color=green, style=dashed];
    edge[style=invis];
    node[shape=none];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>Here, both <span class="math">\(f_3\)</span> and <span class="math">\(f_4\)</span> can be associated with the lightcurve
containing <span class="math">\(f_2\)</span> and <span class="math">\(f_1\)</span>: a &#8220;one-to-many&#8221; association.  Since
<span class="math">\(f_3\)</span> and <span class="math">\(f_4\)</span> are distinct, though, they result in <em>two</em> entries
in the <tt class="docutils literal"><span class="pre">runningcatalog</span></tt> table, or, equivalently, two lightcurves:
<span class="math">\(L_1\)</span> with average flux <span class="math">\(\overline{f_{1,2,3,5}}\)</span> and <span class="math">\(L_2\)</span>
with average flux <span class="math">\(\overline{f_{1,2,4,6}}\)</span>.</p>
<p>Note that <span class="math">\(f_1\)</span> and <span class="math">\(f_2\)</span>: are now being counted <em>twice</em>. Even if
<span class="math">\(f_3\)</span> and <span class="math">\(f_4\)</span> each contribute only half the total flux of
<span class="math">\(f_2\)</span>, the total brightness reached by summing all the lightcurve fluxes
<em>increases</em> when this occurs. Equivalently, increasing the spatial resolution
of the telescope causes the sky to get brighter!</p>
</div>
<div class="section" id="many-to-one-association">
<h5>Many-to-One Association<a class="headerlink" href="#many-to-one-association" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-b45caae866b48f3aa83775ee00eb902ad55e9d2b.png" alt="digraph many2one {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f1 -&gt; f3 -&gt; f5 -&gt; f6 [color=blue];
    f2 -&gt; f4 -&gt; f5 -&gt; f6 [color=green];
    node[shape=box, color=red];
    l1 [label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    l2 [label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f6 -&gt; l1 [style=dashed, color=blue];
    f6 -&gt; l2 [style=dashed, color=green];
    edge[style=invis];
    node[shape=none];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>This situation is similar to that seen above, but in reverse. Initially, two
lightcurves are seen <span class="math">\(L_1\)</span> consisting of <span class="math">\(f_1\)</span> and <span class="math">\(f_3\)</span> and
<span class="math">\(L_2\)</span> consisting of <span class="math">\(f_2\)</span> and <span class="math">\(f_4\)</span>. However, at timestep
<span class="math">\(t_3\)</span> a new measurement is made, <span class="math">\(f_5\)</span>, which is associated with both
<span class="math">\(L_1\)</span> and <span class="math">\(L_2\)</span>. This, and the subsequent measurement <span class="math">\(f_6\)</span>,
are then appended to both lightcurves, resulting in <span class="math">\(L_1\)</span> having average
flux <span class="math">\(\overline{f_{1,3,5,6}}\)</span> and <span class="math">\(L_2\)</span> having average flux
<span class="math">\(\overline{f_{2,4,5,6}}\)</span>. Again, note that <span class="math">\(f_5\)</span> and <span class="math">\(f_6\)</span>
are counted twice.</p>
</div>
<div class="section" id="many-to-many-association">
<h5>Many-to-Many Association<a class="headerlink" href="#many-to-many-association" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">First we illustrate &#8220;true&#8221; many-to-many association. However, for reasons
that will become obvious, this is never actually performed: instead, we
reduce it to a simpler, one-to-one or one-to-many association.</p>
</div>
<p class="graphviz">
<img src="../../_images/graphviz-d18ccfef405df23b4b800d945783a074829f2b8f.png" alt="digraph many2many {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f7 [label=&lt;f&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    f8 [label=&lt;f&lt;SUB&gt;8&lt;/SUB&gt;&gt;];

    f1 -&gt; f3 -&gt; f5 -&gt; f7 [color=blue];
    f2 -&gt; f4 -&gt; f6 -&gt; f8 [color=green];
    f1 -&gt; f3 -&gt; f6 -&gt; f8 [color=coral];
    f2 -&gt; f4 -&gt; f5 -&gt; f7 [color=gold];

    f1 -&gt; f3 -&gt; f6 -&gt; f7 [color=aquamarine];
    f2 -&gt; f4 -&gt; f5 -&gt; f8 [color=blueviolet];

    f1 -&gt; f3 -&gt; f5 -&gt; f8 [color=darkslateblue];
    f2 -&gt; f4 -&gt; f6 -&gt; f7 [color=lawngreen];

    node[shape=box, color=red];
    l1 [label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    l2 [label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    l3 [label=&lt;L&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    l4 [label=&lt;L&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    l5 [label=&lt;L&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    l6 [label=&lt;L&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    l7 [label=&lt;L&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    l8 [label=&lt;L&lt;SUB&gt;8&lt;/SUB&gt;&gt;];

    f7 -&gt; l1 [style=dashed, color=blue];
    f8 -&gt; l2 [style=dashed, color=green];
    f8 -&gt; l3 [style=dashed, color=coral];
    f7 -&gt; l4 [style=dashed, color=gold];
    f7 -&gt; l5 [style=dashed, color=aquamarine];
    f8 -&gt; l6 [style=dashed, color=blueviolet];
    f8 -&gt; l7 [style=dashed, color=darkslateblue];
    f7 -&gt; l8 [style=dashed, color=lawngreen];

    edge[style=invis];
    node[shape=none];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>As shown above, many-to-many association grows quadratically in complexity, as
every possible combination of sources involved in the association results in a
new lightcurve. Further, assuming that neither the sky nor the telescope
configuration change significantly from observation to observation, it&#8217;s
likely that subsequent measurements will also result in many-to-many
associations, doubling the number of lightcurves at every timestep.</p>
<p>It should be obvious that the scenario described is untenable. Instead, all
many-to-many associations are automatically reduced by only taking the source
pairs with the smallest De Ruiter radii such that they become either
one-to-one or one-to-many associations.</p>
<p>For example, using this criterion, both <span class="math">\(f_5\)</span> and <span class="math">\(f_6\)</span> might be
associated with a lightcurve consisting of <span class="math">\(f_1\)</span> and <span class="math">\(f_3\)</span> in the
above. The following situation results:</p>
<p class="graphviz">
<img src="../../_images/graphviz-2f6bf52cec5a2916149950d5b4dd76dfda16d83d.png" alt="digraph many2many {
    rankdir=LR;
    { rank = same;
        f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
        f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    }
    { rank = same;
        f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
        f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    }
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f7 [label=&lt;f&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    f8 [label=&lt;f&lt;SUB&gt;8&lt;/SUB&gt;&gt;];

    f1 -&gt; f3 -&gt; f5 -&gt; f7 [color=blue];
    f2 -&gt; f4 [color=green];
    f1 -&gt; f3 -&gt; f6 -&gt; f8 [color=gold];

    { rank = same;
        node[shape=box, color=red];
        l1 [label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
        l2 [label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
        l3 [label=&lt;L&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    }

    f7 -&gt; l1 [style=dashed, color=blue];
    f4 -&gt; l2 [style=dashed, color=green];
    f8 -&gt; l3 [style=dashed, color=gold];

    edge[style=invis];
    node[shape=none];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;

}" />
</p>
<p>Note that <span class="math">\(L_2\)</span> contains no measurements for timesteps later than
<span class="math">\(t_2\)</span>: the many-to-many association is removed, but at the cost of
truncating this lightcurve.</p>
</div>
</div>
<div class="section" id="multiple-frequency-bands">
<h4>Multiple Frequency Bands<a class="headerlink" href="#multiple-frequency-bands" title="Permalink to this headline">¶</a></h4>
<p>We now introduce the added complexity of multiple bands: the same part of the
sky being observed at the same time, but at different frequencies. Here, we
use just two bands for illustration, but in practice several could be
involved.</p>
<p>When considering multiple frequency bands, the same association procedure,
based only on position, as described above, is employed. However, extra care
must be taken to ensure that the commutative nature of association is
preserved.</p>
<div class="section" id="multi-band-one-to-one-association">
<h5>Multi-Band One-to-One Association<a class="headerlink" href="#multi-band-one-to-one-association" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-6a57cf28e95fb206c5c1ab8b09ed54cb517e4e2f.png" alt="digraph one2one {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f7 [label=&lt;f&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    f8 [label=&lt;f&lt;SUB&gt;8&lt;/SUB&gt;&gt;];

    subgraph cluster0 {
        node [style=filled,color=white];
        f1 -&gt; f2 -&gt; f3 -&gt; f4 [color=blue];
        label = &quot;Band 1&quot;;
    }
    subgraph cluster1 {
        rank = min;
        node [style=filled];
        f5 -&gt; f6 -&gt; f7 -&gt; f8 [color=blue];
        label = &quot;Band 2&quot;;
    }

    edge[color=blue, style=dashed, constraint=true];
    f8 -&gt; l1;
    f4 -&gt; l1;
    l1[label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;, shape=box, color=red];

    node[shape=none];
    edge[style=invis];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>In the simplest case, a one-to-one association is made between each
measurement and an entry in the <tt class="docutils literal"><span class="pre">runningcatalog</span></tt> table. A single lightcurve
results, which we label <span class="math">\(L_1\)</span>, but for which two average fluxes are
calculated: <span class="math">\(\overline{f_{1\cdots{}4}}\)</span> in band 1 and
<span class="math">\(\overline{f_{5\cdots{}8}}\)</span> in band 2.</p>
</div>
<div class="section" id="multi-band-one-to-many-association">
<h5>Multi-Band One-to-Many Association<a class="headerlink" href="#multi-band-one-to-many-association" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-7f48c6972d3990a19060b4ca45cbd800f97175c4.png" alt="digraph one2many {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f7 [label=&lt;f&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    f8 [label=&lt;f&lt;SUB&gt;8&lt;/SUB&gt;&gt;];
    f9 [label=&lt;f&lt;SUB&gt;9&lt;/SUB&gt;&gt;];
    f10 [label=&lt;f&lt;SUB&gt;10&lt;/SUB&gt;&gt;];

    subgraph cluster0 {
        node [style=filled,color=white];
        f1 -&gt; f2 -&gt; f3 -&gt; f5 [color=blue];
        f1 -&gt; f2 -&gt; f4 -&gt; f6 [color=green];
        label = &quot;Band 1&quot;;
    }
    subgraph cluster1 {
        rank = min;
        node [style=filled];
        f7 -&gt; f8 -&gt; f9 -&gt; f10 [color=blue];
        f7 -&gt; f8 -&gt; f9 -&gt; f10 [color=green];
        label = &quot;Band 2&quot;;
    }

    f5 -&gt; l1 [style=dashed, color=blue];
    f10 -&gt; l1 [style=dashed, color=blue];
    l1[label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;, shape=box, color=red];
    f6 -&gt; l2 [style=dashed, color=green];
    f10 -&gt; l2 [style=dashed, color=green];
    l2[label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;, shape=box, color=red];

    node[shape=none];
    edge[style=invis];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>Initially, we proceed as above. However, at <span class="math">\(t_3\)</span>, a one-to-many
association takes place in Band 1. That band therefore bifurcates, and we are
left with two lightcurves: <span class="math">\(L_1\)</span> and <span class="math">\(L_2\)</span>.</p>
<p>No such bifurcation is seen in Band 2. The single measurement <span class="math">\(f_9\)</span> may
be associated with one or both of <span class="math">\(L_1\)</span> and <span class="math">\(L_2\)</span>, depending on
their relative positions. In the former case, one of the lightcurves is
truncated in Band 2. In the latter, a chain of one-to-many associations takes
place with measurements in this band, as both <span class="math">\(f_9\)</span> and <span class="math">\(f_{10}\)</span>
are associated with both lightcurves.</p>
<p>In the situation shown, the resulting average fluxes for <span class="math">\(L_1\)</span> are
<span class="math">\(\overline{f_{1,2,3,5}}\)</span> in Band 1 and
<span class="math">\(\overline{f_{7\cdots{}10}}\)</span> in Band 2, while those for <span class="math">\(L_2\)</span> are
<span class="math">\(\overline{f_{1,2,4,6}}\)</span>  and <span class="math">\(\overline{f_{7\cdots{}10}}\)</span>
respectively. Note that the entire flux in Band 2, as well as <span class="math">\(f_1\)</span> and
<span class="math">\(f_2\)</span>, is now counted twice.</p>
</div>
<div class="section" id="multi-band-many-to-one-association">
<h5>Multi-Band Many-to-One Association<a class="headerlink" href="#multi-band-many-to-one-association" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-be10579e0fe36b60dc7cf46b24183bb0407e95d8.png" alt="digraph many2one {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f7 [label=&lt;f&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    f8 [label=&lt;f&lt;SUB&gt;8&lt;/SUB&gt;&gt;];
    f9 [label=&lt;f&lt;SUB&gt;9&lt;/SUB&gt;&gt;];
    f10 [label=&lt;f&lt;SUB&gt;10&lt;/SUB&gt;&gt;];
    f11 [label=&lt;f&lt;SUB&gt;11&lt;/SUB&gt;&gt;];
    f12 [label=&lt;f&lt;SUB&gt;12&lt;/SUB&gt;&gt;];
    f13 [label=&lt;f&lt;SUB&gt;13&lt;/SUB&gt;&gt;];
    f14 [label=&lt;f&lt;SUB&gt;14&lt;/SUB&gt;&gt;];

    subgraph cluster0 {
        node [style=filled,color=white];
        f1 -&gt; f3 -&gt; f5 -&gt; f6 [color=blue];
        f2 -&gt; f4 -&gt; f5 -&gt; f6 [color=green];
        label = &quot;Band 1&quot;;
    }
    subgraph cluster1 {
        rank = min;
        node [style=filled];
        f7 -&gt; f9 -&gt; f11 -&gt; f13 [color=blue];
        f8 -&gt; f10 -&gt; f12 -&gt; f14 [color=green];
        label = &quot;Band 2&quot;;
    }


    f6 -&gt; l1 [style=dashed, color=blue];
    f13 -&gt; l1 [style=dashed, color=blue];
    l1[label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;, shape=box, color=red];
    f6 -&gt; l2 [style=dashed, color=green];
    f14 -&gt; l2 [style=dashed, color=green];
    l2[label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;, shape=box, color=red];

    node[shape=none];
    edge[style=invis];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>At first, <span class="math">\(L_1\)</span> and <span class="math">\(L_2\)</span> are completely independent. However, at
<span class="math">\(t_3\)</span>, <span class="math">\(f_5\)</span> undergoes a many-to-one association with both of
them. The same applies to <span class="math">\(f_6\)</span>. In Band 2, the lightcurves remain
independent.  <span class="math">\(L_1\)</span> therefore has average fluxes
<span class="math">\(\overline{f_{1,3,5,6}}\)</span> in Band 1 and <span class="math">\(\overline{f_{7,9,11,13}}\)</span>
in Band 2, and <span class="math">\(L_2\)</span> has average fluxes <span class="math">\(\overline{f_{2,4,5,6}}\)</span>
in Band 1 and <span class="math">\(\overline{f_{8,10,12,14}}\)</span> in Band 2.</p>
</div>
<div class="section" id="multi-band-many-to-one-association-2">
<h5>Multi-Band Many-to-One Association (2)<a class="headerlink" href="#multi-band-many-to-one-association-2" title="Permalink to this headline">¶</a></h5>
<p class="graphviz">
<img src="../../_images/graphviz-700e4025736f9f6b2193903221f6c4a0fdac1c0c.png" alt="digraph many2one {
    rankdir=LR;
    f1 [label=&lt;f&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    f2 [label=&lt;f&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    f3 [label=&lt;f&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    f4 [label=&lt;f&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    f5 [label=&lt;f&lt;SUB&gt;5&lt;/SUB&gt;&gt;];
    f6 [label=&lt;f&lt;SUB&gt;6&lt;/SUB&gt;&gt;];
    f7 [label=&lt;f&lt;SUB&gt;7&lt;/SUB&gt;&gt;];
    f8 [label=&lt;f&lt;SUB&gt;8&lt;/SUB&gt;&gt;];
    f9 [label=&lt;f&lt;SUB&gt;9&lt;/SUB&gt;&gt;];
    f10 [label=&lt;f&lt;SUB&gt;10&lt;/SUB&gt;&gt;];
    f11 [label=&lt;f&lt;SUB&gt;11&lt;/SUB&gt;&gt;];
    f12 [label=&lt;f&lt;SUB&gt;12&lt;/SUB&gt;&gt;];
    f13 [label=&lt;f&lt;SUB&gt;13&lt;/SUB&gt;&gt;];
    f14 [label=&lt;f&lt;SUB&gt;14&lt;/SUB&gt;&gt;];
    f15 [label=&lt;f&lt;SUB&gt;15&lt;/SUB&gt;&gt;];
    f16 [label=&lt;f&lt;SUB&gt;16&lt;/SUB&gt;&gt;];

    subgraph cluster0 {
        node [style=filled,color=white];
        f1 -&gt; f3 -&gt; f5 -&gt; f7 [color=blue];
        f2 -&gt; f4 -&gt; f6 -&gt; f8 [color=green];
        label = &quot;Band 1&quot;;
    }
    subgraph cluster1 {
        rank = min;
        node [style=filled];
        f9 -&gt; f11 -&gt; f13 -&gt; f15 [color=blue];
        f10 -&gt; f12 -&gt; f13 -&gt; f15 [color=green];
        f12 -&gt; f14 [style=invis];
        f14 -&gt; f16 [color=gold];
        label = &quot;Band 2&quot;;
    }

    f7 -&gt; l1 [style=dashed, color=blue];
    f15 -&gt; l1 [style=dashed, color=blue];
    l1[label=&lt;L&lt;SUB&gt;1&lt;/SUB&gt;&gt;, shape=box, color=red];
    f8 -&gt; l2 [style=dashed, color=green];
    f15 -&gt; l2 [style=dashed, color=green];
    l2[label=&lt;L&lt;SUB&gt;2&lt;/SUB&gt;&gt;, shape=box, color=red];
    f16 -&gt; l3 [style=dashed, color=gold]
    l3[label=&lt;L&lt;SUB&gt;3&lt;/SUB&gt;&gt;, shape=box, color=red];

    node[shape=none];
    edge[style=invis];
    t1 [label=&lt;t&lt;SUB&gt;1&lt;/SUB&gt;&gt;];
    t2 [label=&lt;t&lt;SUB&gt;2&lt;/SUB&gt;&gt;];
    t3 [label=&lt;t&lt;SUB&gt;3&lt;/SUB&gt;&gt;];
    t4 [label=&lt;t&lt;SUB&gt;4&lt;/SUB&gt;&gt;];
    t1 -&gt; t2 -&gt; t3 -&gt; t4;
}" />
</p>
<p>In this case, we initially have two separate lightcurves. However, at
<span class="math">\(t_3\)</span>, <span class="math">\(f_{13}\)</span> is associated with both lightcurves in Band 2,
while <span class="math">\(f_{14}\)</span> is associated with neither. Three lightcurves result, as
shown.</p>
<p>It is worth considering the ordering of database insertion at this point. In
particular, consider that either one of <span class="math">\(f_6\)</span> and <span class="math">\(f_{14}\)</span> may be
inserted before the other. After each insertion, the average position of the
<tt class="docutils literal"><span class="pre">runningcatalog</span></tt> entry is recalculated, and this may affect future
associations.</p>
<p>For example, assume that <span class="math">\(f_6\)</span> is inserted before <span class="math">\(f_{14}\)</span>. In
this case, the average position of <span class="math">\(f_{2,4,6,10,12}\)</span> is not associated
with <span class="math">\(f_{14}\)</span>. However, if <span class="math">\(f_{14}\)</span> were to be inserted first, it
would be compared for association with the average position of
<span class="math">\(f_{2,4,10,12}\)</span>. This may well produce a different result!</p>
<p>For obvious reasons, it is desirable for the database contents to be
independent of the order of insertion (otherwise, its ultimate contents
become non-deterministic given the input data). For this reason, every
insertion at a given timestep causes the associations for <em>all</em> datapoints at
that timestep to be revaluated, rather than simply the inserted measurement
simply being associated with the already extant lightcurves.</p>
</div>
</div>
</div>
</div>
<div class="section" id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
<p>It is immediately obvious from the examples given above that, in all but the
simplest cases, there is potential for confusion here. In particular, note
that simply summing the average fluxes of all the lightcurves in the
<tt class="docutils literal"><span class="pre">runningcatalog_flux</span></tt> table in a given band is not an appropriate way to
estimate the total brightness of the sky: this may count individual flux
measurements multiple times.</p>
<p>Further, the way the source association is handled may result in false
detections of transients. In the case of a one-to-many association, for
example, a single bright source can be associated with two sources each of a
fraction of the brightness. This results in two lightcurves, both containing a
(very transient like!) sudden step in flux. A similar outcome can, of course,
also result from a many-to-one association.</p>
<p>There are two potential areas of improvement which should be investigated.</p>
<p class="rubric">Flux division</p>
<p>In a one-to-many or many-to-one association, rather than simply allocating the
full flux of the &#8220;one&#8221; measurement to each of the &#8220;many&#8221; lightcurves, it
could be split such that each was only allotted a portion of the total. In this
way, the total brightness of the sky could be maintained.</p>
<p>The most appropriate division is not obvious. A simple model could allocate
each of <span class="math">\(n\)</span> lightcurves a fraction <span class="math">\(1/n\)</span> of the total flux of the
single measurement. A more elaborate procedure would weight the allocation by
the flux in each of the <span class="math">\(n\)</span> lightcurves, such that brighter sources are
allocated a larger fraction of the flux.</p>
<p>Whatever flux allocation procedure is adopted, however, involves making
assumptions about what fraction should be allocated to each source.
Further, it may also increase the computational complexity in the
database, as lightcurve statistics are no longer simply calculated over
source measurements, but must also take account of fractional allocations.</p>
<p class="rubric">Smarter association</p>
<p>The current association procedure is purely based on the positions of the
sources and their uncertainties. By incorporating more information about
the sources, ambiguities in association could often be avoided.</p>
<p>For example, consider the case of a many-to-many association involving an
extended source and a point source. It is likely perfectly reasonable to
assume that the measurement of the extended source at time <span class="math">\(t_2\)</span>
should only be associated with the extended source at time <span class="math">\(t_1\)</span>,
and similarly for the point source: in this way, the many-to-many
association can be easily reduced to a much simpler case.</p>
<p>Again, though, a number of assumptions go into any procedure like this. In
particular, given that our ultimate aim is to detect transient and
variable sources, we should be wary of any procedure that implicitly
assumes the sky is unchanging. Further, again the issue of database
complexity should be considered: incorporating more logic of this sort is
expensive, in terms of both compute and developer time.</p>
</div>
<div class="section" id="recommendations">
<h2>Recommendations<a class="headerlink" href="#recommendations" title="Permalink to this headline">¶</a></h2>
<p>Although it is clear that improvements can and will need to be made to the
procedures adopted, it is not immediately obvious how best to proceed.
Therefore, it is suggested that refinements be deferred until more practical
experience has been obtained.</p>
<p>To that end, we suggest the following:</p>
<ol class="arabic simple">
<li>Commissioners and scientists working with the lightcurve database, as well
as developers of tools designed to detect transients based upon it, must
familiarize themselves with the issues described above.</li>
<li>The <a class="reference external" href="http://archive.transientskp.org/">TKP Lightcurve Archive</a> should be
explicit about which measurements have gone into a displayed lightcurve or
other measurement. The figures which accompany this document are easy to
programmatically generate using <a class="reference external" href="http://www.graphviz.org/">GraphViz</a>, and
show clearly the heritage of a given lightcurve; we suggest, therefore,
that they or a derivative of them should be shown on the website.</li>
<li>As more source measurements are collected, statistics can be collected to
demonstrate to what extent the problems anticipated are observed in
real-world use. For example, in the ideal case, the total number of
measurements included in all the lightcurves would be equal to the number
of measurements made on images; in practice, however, the former will be
bigger, since measurements may be counted twice. Observing the
&#8220;overcounting fraction&#8221; as the database grows will help understand the
nature and severity of the problem.</li>
</ol>
</div>
<div class="section" id="detailed-logic-flow">
<span id="database-assoc-details"></span><h2>Detailed logic flow<a class="headerlink" href="#detailed-logic-flow" title="Permalink to this headline">¶</a></h2>
<p>Herein we give an algorithmic description of how the source association
routines work.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The following detail is really aimed at developers or particularly
interested users only, and can certainly be skipped on first reading.</p>
</div>
<p>We assume that source extraction has been run on input images,
and new measurements have been inserted into the <tt class="docutils literal"><span class="pre">extractedsource</span></tt> table.</p>
<div class="section" id="clean-any-previously-created-temporary-listings">
<h3>Clean any previously created temporary listings.<a class="headerlink" href="#clean-any-previously-created-temporary-listings" title="Permalink to this headline">¶</a></h3>
<p>To ensure a clean start, we first run <tt class="docutils literal"><span class="pre">_empty_temprunningcatalog</span></tt>,
which does what it says on the tin.</p>
</div>
<div class="section" id="generate-a-list-of-candidate-runningcatalog-extractedsource-associations">
<h3>Generate a list of candidate runningcatalog-extractedsource associations<a class="headerlink" href="#generate-a-list-of-candidate-runningcatalog-extractedsource-associations" title="Permalink to this headline">¶</a></h3>
<p>Performed by: <a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_temprunningcatalog" title="tkp.db.associations._insert_temprunningcatalog"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_temprunningcatalog()</span></tt></a></p>
<p>(See also: <a class="reference internal" href="schema.html#database-temprunningcatalog"><em>temprunningcatalog</em></a> table. )</p>
<p>This function generates a temporary table listing possible associations with
previously catalogued sources.</p>
<p>For a given <tt class="docutils literal"><span class="pre">image_id</span></tt>:</p>
<blockquote>
<div><ul class="simple">
<li>Select all the relevant extractedsource entries, and</li>
<li>For each extractedsource, create a bunch of table entries detailing
candidate associations with runningcatalog entries which are:<ul>
<li>In the same declination zone as the extractedsource</li>
<li>Have a weighted mean position for which the RA and DEC are within a box
of half-width <tt class="docutils literal"><span class="pre">radius</span></tt> degrees from the extractedsource.
(This places a hard limit on the maximum association radius).</li>
<li>Have a weighted mean position within a user-specified De Ruiter radius of
the extractedsource.</li>
</ul>
</li>
<li>Each of these rows representing a candidate association is populated with all
the values which would represent an update to the corresponding
runningcatalog and runningcatalog_flux entries, if the association is later
determined to be definitive.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="trim-the-many-to-many-links-to-prevent-exponentional-database-growth">
<h3>Trim the &#8216;many-to-many&#8217; links to prevent exponentional database growth<a class="headerlink" href="#trim-the-many-to-many-links-to-prevent-exponentional-database-growth" title="Permalink to this headline">¶</a></h3>
<p>Performed by: <a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._flag_many_to_many_tempruncat" title="tkp.db.associations._flag_many_to_many_tempruncat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._flag_many_to_many_tempruncat()</span></tt></a></p>
<p>Especially if we employ a large De Ruiter radius limit, we may generate a large
number of candidate associations which result in a complex web of possible
lightcurves. We reduce this to a more manageable situation by trimming some of
the &#8216;weaker&#8217; candidate associations.</p>
<p>First, inspect the temprunningcatalog table:</p>
<blockquote>
<div><ul class="simple">
<li>Select entries for which the extractedsource is listed more than once.</li>
<li>Of these entries, select those for which the runcat id is listed more than
once in temprunningcatalog.</li>
<li>Use this selection to determine the runningcatalog id of minimum De Ruiter
radius, for each extracted source which is part of a many-to-many set.</li>
<li>Then, using this per-extractedsource minimum DR radius, reapply the above
filters to select multiply-associated entries, and select all entries for
which the runcat id  has a larger than  minimum DR radius to the
extractedsource.</li>
<li>Return the runcat-extractedsource identifying pair values for all
non-optimal entries in many-to-many sets.</li>
</ul>
</div></blockquote>
<p>Finally, use these identifiers to set all these entries as <tt class="docutils literal"><span class="pre">inactive</span> <span class="pre">=</span> <span class="pre">TRUE</span></tt>.</p>
<p>Or, in pseudo-mathematical terms, tempruncat describes the edges of a graph,
linking nodes (sources) from two spaces (previous runcat entries, newly
extracted entries).  (There are no intra-space links).
<a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._flag_many_to_many_tempruncat" title="tkp.db.associations._flag_many_to_many_tempruncat"><tt class="xref py py-func docutils literal"><span class="pre">_flag_many_to_many_tempruncat()</span></tt></a> trims this graph using the De Ruiter
radius as a ranking metric, to ensure that any connected sub-graph has
multiple nodes in <em>at most</em> one of the two spaces.</p>
</div>
<div class="section" id="deal-with-the-one-to-many-runcat-to-extractedsource-link-sub-graphs">
<h3>Deal with the  &#8216;one-to-many&#8217; runcat-to-extractedsource link sub-graphs<a class="headerlink" href="#deal-with-the-one-to-many-runcat-to-extractedsource-link-sub-graphs" title="Permalink to this headline">¶</a></h3>
<p>When we observe two new sources in the region of a previous known source,
it is unclear if this is due to increased resolution, or a new source.
To resolve this, we hedge our bets and replace the old single runcat entry
with two new entries - these are identical up to the current &#8216;fork&#8217;.
This is done in <a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_many_runcat" title="tkp.db.associations._insert_1_to_many_runcat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_many_runcat()</span></tt></a>,
and <a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._flag_1_to_many_inactive_runcat" title="tkp.db.associations._flag_1_to_many_inactive_runcat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._flag_1_to_many_inactive_runcat()</span></tt></a> then
flags the old entries as ready for deletion.</p>
<p>Having inserted these new runningcatalog entries, we must copy over all
the relevant information to new entries in the associated tables, then delete
the outdated rows; see</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_many_runcat_flux" title="tkp.db.associations._insert_1_to_many_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_many_runcat_flux()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_runcat_flux" title="tkp.db.associations._delete_1_to_many_inactive_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._delete_1_to_many_inactive_runcat_flux()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_many_basepoint_assocxtrsource" title="tkp.db.associations._insert_1_to_many_basepoint_assocxtrsource"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_many_basepoint_assocxtrsource()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_many_replacement_assocxtrsource" title="tkp.db.associations._insert_1_to_many_replacement_assocxtrsource"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_many_replacement_assocxtrsource()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_assocxtrsource" title="tkp.db.associations._delete_1_to_many_inactive_assocxtrsource"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._delete_1_to_many_inactive_assocxtrsource()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_many_assocskyrgn" title="tkp.db.associations._insert_1_to_many_assocskyrgn"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_many_assocskyrgn()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_assocskyrgn" title="tkp.db.associations._delete_1_to_many_inactive_assocskyrgn"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._delete_1_to_many_inactive_assocskyrgn()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_many_newsource" title="tkp.db.associations._insert_1_to_many_newsource"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_many_newsource()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_newsource" title="tkp.db.associations._delete_1_to_many_inactive_newsource"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._delete_1_to_many_inactive_newsource()</span></tt></a></li>
</ul>
</div></blockquote>
<p>Finally, <a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._flag_1_to_many_inactive_tempruncat" title="tkp.db.associations._flag_1_to_many_inactive_tempruncat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._flag_1_to_many_inactive_tempruncat()</span></tt></a>
flags the one-to-many associations in <tt class="docutils literal"><span class="pre">temprunningcatalog</span></tt> as inactive,
so we can easily distinguish remaining one-to-one associations.</p>
</div>
<div class="section" id="process-all-remaining-associations">
<h3>Process all remaining associations<a class="headerlink" href="#process-all-remaining-associations" title="Permalink to this headline">¶</a></h3>
<p>Performed by:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_1_assoc" title="tkp.db.associations._insert_1_to_1_assoc"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_1_assoc()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._update_1_to_1_runcat" title="tkp.db.associations._update_1_to_1_runcat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._update_1_to_1_runcat()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._update_1_to_1_runcat_flux" title="tkp.db.associations._update_1_to_1_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._update_1_to_1_runcat_flux()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_1_runcat_flux" title="tkp.db.associations._insert_1_to_1_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_1_to_1_runcat_flux()</span></tt></a></li>
</ul>
</div></blockquote>
<p>We now process all the remaining active associations listed in temprunningcatalog.</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_1_to_1_assoc" title="tkp.db.associations._insert_1_to_1_assoc"><tt class="xref py py-func docutils literal"><span class="pre">_insert_1_to_1_assoc()</span></tt></a> Inserts all the remaining
active links listed in tempruncat, into assocxtrsource.  These links all refer
to a still-valid runningcatalog entry from a previous source association run.
(This actually includes those candidate links in &#8216;many-to-one&#8217; sets, e.g.
sources merged due to a lower-resolution image - hence we set <tt class="docutils literal"><span class="pre">type</span> <span class="pre">=</span> <span class="pre">3</span></tt>).</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._update_1_to_1_runcat" title="tkp.db.associations._update_1_to_1_runcat"><tt class="xref py py-func docutils literal"><span class="pre">_update_1_to_1_runcat()</span></tt></a> then performs the corresponding update on the
runningcatalog table, copying across the values calculated during the generation
of temprunningcatalog.</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._update_1_to_1_runcat_flux" title="tkp.db.associations._update_1_to_1_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">_update_1_to_1_runcat_flux()</span></tt></a> grabs all the columns relevant to
the runnincatalog_flux entries, from the still active entries in
temprunningcatalog, and updates the <tt class="docutils literal"><span class="pre">runningcatalog_flux</span></tt> table accordingly.</p>
</div>
<div class="section" id="process-remaining-extractedsources-those-without-associations">
<h3>Process remaining extractedsources (those without associations)<a class="headerlink" href="#process-remaining-extractedsources-those-without-associations" title="Permalink to this headline">¶</a></h3>
<p>Performed by:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat" title="tkp.db.associations._insert_new_runcat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_new_runcat()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat_flux" title="tkp.db.associations._insert_new_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_new_runcat_flux()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat_skyrgn_assocs" title="tkp.db.associations._insert_new_runcat_skyrgn_assocs"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_new_runcat_skyrgn_assocs()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_assocxtrsource" title="tkp.db.associations._insert_new_assocxtrsource"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._insert_new_assocxtrsource()</span></tt></a></li>
</ul>
</div></blockquote>
<p>We still need to insert the &#8216;new&#8217; sources, i.e. those extractions without an
identified association.</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat" title="tkp.db.associations._insert_new_runcat"><tt class="xref py py-func docutils literal"><span class="pre">_insert_new_runcat()</span></tt></a> is run first, since the database constraints are
already satisfied (pre-existent xtrsrc and dataset-id).  First, we pre-select
those extractedsources which were discovered in the current image.  Then we
filter to just those which do not have any associations, by selecting those
extractedsources listed in the image but not in the temprunningcatalog  (A
left outer join on xtrsrc where temprunningcatalog.xtrsrc is NULL).</p>
<p>We initialise the averages (position, flux, etc) by pulling in the relevant
values from extractedsource, and the dataset id from the image table.</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat_flux" title="tkp.db.associations._insert_new_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">_insert_new_runcat_flux()</span></tt></a> performs a similar trick to select the
&#8216;new-source&#8217; extractsources, then cross-matches against the xtrsrc id to
select the new runcat entries.  With these in hand it&#8217;s easy to insert new
runcat_flux entries, pulling in the relevant id from runningcatalog, band and
stokes from image table, and flux values from extractedsource.</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat_skyrgn_assocs" title="tkp.db.associations._insert_new_runcat_skyrgn_assocs"><tt class="xref py py-func docutils literal"><span class="pre">_insert_new_runcat_skyrgn_assocs()</span></tt></a> performs a positional check
against all known skyregions to see which regions this source lies within, and
inserts links in the <tt class="docutils literal"><span class="pre">assocskyrgn</span></tt> table accordingly.</p>
<p><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_assocxtrsource" title="tkp.db.associations._insert_new_assocxtrsource"><tt class="xref py py-func docutils literal"><span class="pre">_insert_new_assocxtrsource()</span></tt></a> Performs the same routine of grab
&#8216;new-source&#8217; entries, match new runcat entries, as
<a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._insert_new_runcat_flux" title="tkp.db.associations._insert_new_runcat_flux"><tt class="xref py py-func docutils literal"><span class="pre">_insert_new_runcat_flux()</span></tt></a> - it&#8217;s then trival to insert the relevant
entries in assocxtrsource. These are then marked as a <tt class="docutils literal"><span class="pre">type</span> <span class="pre">=</span> <span class="pre">4</span></tt>
association.</p>
</div>
<div class="section" id="determine-if-a-new-source-is-a-likely-transient">
<h3>Determine if a new source is a likely transient<a class="headerlink" href="#determine-if-a-new-source-is-a-likely-transient" title="Permalink to this headline">¶</a></h3>
<p>Performed by <a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._determine_newsource_previous_limits" title="tkp.db.associations._determine_newsource_previous_limits"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._determine_newsource_previous_limits()</span></tt></a></p>
</div>
<div class="section" id="cleanup">
<h3>Cleanup<a class="headerlink" href="#cleanup" title="Permalink to this headline">¶</a></h3>
<p>Performed by:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._empty_temprunningcatalog" title="tkp.db.associations._empty_temprunningcatalog"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._empty_temprunningcatalog()</span></tt></a></li>
<li><a class="reference internal" href="../tkp/database/association.html#tkp.db.associations._delete_inactive_runcat" title="tkp.db.associations._delete_inactive_runcat"><tt class="xref py py-func docutils literal"><span class="pre">tkp.db.associations._delete_inactive_runcat()</span></tt></a></li>
</ul>
</div></blockquote>
<p>Now that all the new extractions have been dealt with, we take care of some
loose ends.
We delete all rows from the <tt class="docutils literal"><span class="pre">temprunningcatalog</span></tt> table,
and finally delete those runningcatalog entries which we have now superceded,
via a simple <tt class="docutils literal"><span class="pre">inactive</span> <span class="pre">=</span> <span class="pre">TRUE</span></tt> filter.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/lofar.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Source Association Logic</a><ul>
<li><a class="reference internal" href="#database-structure-association-procedure">Database Structure &amp; Association Procedure</a><ul>
<li><a class="reference internal" href="#case-studies">Case Studies</a><ul>
<li><a class="reference internal" href="#single-frequency-band">Single Frequency Band</a><ul>
<li><a class="reference internal" href="#one-to-one-association">One-to-One Association</a></li>
<li><a class="reference internal" href="#one-to-many-association">One-to-Many Association</a></li>
<li><a class="reference internal" href="#many-to-one-association">Many-to-One Association</a></li>
<li><a class="reference internal" href="#many-to-many-association">Many-to-Many Association</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiple-frequency-bands">Multiple Frequency Bands</a><ul>
<li><a class="reference internal" href="#multi-band-one-to-one-association">Multi-Band One-to-One Association</a></li>
<li><a class="reference internal" href="#multi-band-one-to-many-association">Multi-Band One-to-Many Association</a></li>
<li><a class="reference internal" href="#multi-band-many-to-one-association">Multi-Band Many-to-One Association</a></li>
<li><a class="reference internal" href="#multi-band-many-to-one-association-2">Multi-Band Many-to-One Association (2)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#discussion">Discussion</a></li>
<li><a class="reference internal" href="#recommendations">Recommendations</a></li>
<li><a class="reference internal" href="#detailed-logic-flow">Detailed logic flow</a><ul>
<li><a class="reference internal" href="#clean-any-previously-created-temporary-listings">Clean any previously created temporary listings.</a></li>
<li><a class="reference internal" href="#generate-a-list-of-candidate-runningcatalog-extractedsource-associations">Generate a list of candidate runningcatalog-extractedsource associations</a></li>
<li><a class="reference internal" href="#trim-the-many-to-many-links-to-prevent-exponentional-database-growth">Trim the &#8216;many-to-many&#8217; links to prevent exponentional database growth</a></li>
<li><a class="reference internal" href="#deal-with-the-one-to-many-runcat-to-extractedsource-link-sub-graphs">Deal with the  &#8216;one-to-many&#8217; runcat-to-extractedsource link sub-graphs</a></li>
<li><a class="reference internal" href="#process-all-remaining-associations">Process all remaining associations</a></li>
<li><a class="reference internal" href="#process-remaining-extractedsources-those-without-associations">Process remaining extractedsources (those without associations)</a></li>
<li><a class="reference internal" href="#determine-if-a-new-source-is-a-likely-transient">Determine if a new source is a likely transient</a></li>
<li><a class="reference internal" href="#cleanup">Cleanup</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="schema.html"
                        title="previous chapter">Schema</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="howto.html"
                        title="next chapter">HOWTO</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devref/database/assoc.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="howto.html" title="HOWTO"
             >next</a> |</li>
        <li class="right" >
          <a href="schema.html" title="Schema"
             >previous</a> |</li>
        <li><a href="../../index.html">LOFAR Transients Pipeline 2.0-pre documentation</a> &raquo;</li>
          <li><a href="../index.html" >Developer&#8217;s Reference Guide</a> &raquo;</li>
          <li><a href="index.html" >Overview of the TKP Database</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011—2014, LOFAR Transients Key Science Project.
    </div>
  </body>
</html>