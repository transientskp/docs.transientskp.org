<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tkp.db.associations &mdash; LOFAR Transients Pipeline 2.0-pre documentation</title>
    
    <link rel="stylesheet" href="../../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.0-pre',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/lofar.ico"/>
    <link rel="top" title="LOFAR Transients Pipeline 2.0-pre documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">LOFAR Transients Pipeline 2.0-pre documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tkp.db.associations</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A collection of back end subroutines (mostly SQL queries), In this module we</span>
<span class="sd">deal with source association.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tkp.db</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="associate_extracted_sources"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations.associate_extracted_sources">[docs]</a><span class="k">def</span> <span class="nf">associate_extracted_sources</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">deRuiter_r</span><span class="p">,</span> <span class="n">new_source_sigma_margin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Associate extracted sources with sources detected in the running</span>
<span class="sd">    catalog.</span>

<span class="sd">    See the &quot;developer&#39;s reference&quot; section of the docs for a step-by-step</span>
<span class="sd">    breakdown of the logic encapsulated here.</span>

<span class="sd">    The dimensionless distance between two sources is given by the</span>
<span class="sd">    &quot;De Ruiter radius&quot;, see Chapters 2 &amp; 3 of Scheers&#39; thesis.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Using a De Ruiter radius of </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">deRuiter_r</span><span class="p">,))</span>
    <span class="c">##This is used as a check that everything from the sourcefinder is sensible.</span>
    <span class="c">##Currently switched off as it&#39;s incompatible with sources about the meridian.</span>
<span class="c">#    _delete_bad_blind_extractions(conn, image_id)</span>
    <span class="n">_empty_temprunningcatalog</span><span class="p">()</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="c">#| Here we select all extracted sources that have one or|</span>
    <span class="c">#| more counterparts in the runningcatalog              |</span>
    <span class="c">#| Association pairs are of the sequence runcat-xtrsrc, |</span>
    <span class="c">#| which may be matching one of the following cases:    |</span>
    <span class="c">#| many-to-many, many-to-one, one-to-many, one-to-many  |</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="n">mw</span> <span class="o">=</span> <span class="n">_check_meridian_wrap</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="n">_insert_temprunningcatalog</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">deRuiter_r</span><span class="p">,</span> <span class="n">mw</span><span class="p">)</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="c">#| Here we process (flag) the many-to-many associations.|</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="c"># _process_many_to_many()</span>
    <span class="n">_flag_many_to_many_tempruncat</span><span class="p">()</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="c">#| After this, the assocs have been reduced to many-to-1|</span>
    <span class="c">#| which are treated identical as 1-to-1, and 1-to-many.|</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="c"># _process_many_to_1() =&gt; process_1_to_1()</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="c">#| Here we process the one-to-many associations.        |</span>
    <span class="c">#+------------------------------------------------------+</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_insert_1_to_many_runcat</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Database</span><span class="p">()</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RhombusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error caught around _insert_1_to_many_runcat - &quot;</span>
                 <span class="s">&quot;possible &#39;RhombusError&#39;. See Issue #4778. Will now re-raise.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">e</span>

    <span class="n">_flag_1_to_many_inactive_runcat</span><span class="p">()</span>

    <span class="n">_insert_1_to_many_runcat_flux</span><span class="p">()</span>
    <span class="n">_delete_1_to_many_inactive_runcat_flux</span><span class="p">()</span>

    <span class="n">_insert_1_to_many_basepoint_assocxtrsource</span><span class="p">()</span>
    <span class="n">_insert_1_to_many_replacement_assocxtrsource</span><span class="p">()</span>
    <span class="n">_delete_1_to_many_inactive_assocxtrsource</span><span class="p">()</span>

    <span class="n">_insert_1_to_many_assocskyrgn</span><span class="p">()</span>
    <span class="n">_delete_1_to_many_inactive_assocskyrgn</span><span class="p">()</span>

    <span class="n">_insert_1_to_many_transient</span><span class="p">()</span>
    <span class="n">_delete_1_to_many_inactive_transient</span><span class="p">()</span>

    <span class="n">_flag_1_to_many_inactive_tempruncat</span><span class="p">()</span>

    <span class="c">#+-----------------------------------------------------+</span>
    <span class="c">#| Here we process the one-to-one associations         |</span>
    <span class="c">#+-----------------------------------------------------+</span>
    <span class="c"># _process_1_to_1()</span>
    <span class="n">_insert_1_to_1_assoc</span><span class="p">()</span>
    <span class="n">_update_1_to_1_runcat</span><span class="p">()</span>
    <span class="n">_update_1_to_1_runcat_flux</span><span class="p">()</span>  <span class="c"># update flux in existing band</span>
    <span class="n">_insert_1_to_1_runcat_flux</span><span class="p">()</span>  <span class="c"># insert flux for new band</span>
    <span class="c">#+-------------------------------------------------------+</span>
    <span class="c">#| Here we take care of the extracted sources that could |</span>
    <span class="c">#| not be associated with any runningcatalog source      |</span>
    <span class="c">#+-------------------------------------------------------+</span>
    <span class="n">_insert_new_runcat</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="n">_insert_new_runcat_flux</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="n">_insert_new_runcat_skyrgn_assocs</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="n">_insert_new_assocxtrsource</span><span class="p">(</span><span class="n">image_id</span><span class="p">)</span>
    <span class="n">_determine_newsource_previous_limits</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">new_source_sigma_margin</span><span class="p">)</span>

    <span class="n">_empty_temprunningcatalog</span><span class="p">()</span>
    <span class="n">_update_ff_runcat_extractedsource</span><span class="p">()</span>
    <span class="n">_delete_inactive_runcat</span><span class="p">()</span>

<span class="c">##############################################################################</span>
<span class="c"># Subroutines...</span>
<span class="c"># Here be SQL dragons.</span>
<span class="c">##############################################################################</span></div>
<div class="viewcode-block" id="_delete_bad_blind_extractions"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._delete_bad_blind_extractions">[docs]</a><span class="k">def</span> <span class="nf">_delete_bad_blind_extractions</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove blind extractions centred outside designated extract region.</span>

<span class="sd">    These occur sometimes due to highly elliptical fits on noisy data,</span>
<span class="sd">    creating a best fit centred outside the original pixel region.</span>
<span class="sd">    The source-extraction code has been modified to (probably) prevent this,</span>
<span class="sd">    but we check for them anyway.</span>

<span class="sd">    NB. We currently only delete blind extractions.</span>
<span class="sd">    We expect that occasionally forced fits to sources just inside the extraction</span>
<span class="sd">    radius might converge just outside, but these should be restricted to a</span>
<span class="sd">    very small additional margin. By not deleting these edge cases,</span>
<span class="sd">    the data allows us to construct proper lightcurves, and (I think) does</span>
<span class="sd">    not contribute to their weighted mean positions (so sources cannot &#39;migrate&#39;</span>
<span class="sd">    across the border).</span>
<span class="sd">    TODO(TS): Check this.</span>

<span class="sd">    Only extractions from the specified image are checked for deletion.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Number of extractedsource rows deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">DELETE</span>
<span class="s">FROM extractedsource</span>
<span class="s">WHERE image = </span><span class="si">%(imgid)s</span><span class="s"></span>
<span class="s">  AND id IN (SELECT badid</span>
<span class="s">              FROM (SELECT ex0.id as badid</span>
<span class="s">                    ,SQRT(</span>
<span class="s">                      ( (ex0.ra  - sky.centre_ra)* COS(RADIANS(sky.centre_decl))</span>
<span class="s">                     *(ex0.ra  - sky.centre_ra)* COS(RADIANS(sky.centre_decl))</span>
<span class="s">                      + (ex0.decl - sky.centre_decl) * (ex0.decl - sky.centre_decl))</span>
<span class="s">                      ) as distance</span>
<span class="s">                      ,sky.xtr_radius as xtr_radius</span>
<span class="s">                  FROM extractedsource ex0</span>
<span class="s">                      ,image im</span>
<span class="s">                      ,skyregion sky</span>
<span class="s">                  WHERE im.id = </span><span class="si">%(imgid)s</span><span class="s"></span>
<span class="s">                   AND ex0.image = im.id</span>
<span class="s">                   AND ex0.extract_type = 0</span>
<span class="s">                   AND im.skyrgn = sky.id</span>
<span class="s">                   ) t1</span>
<span class="s">               WHERE t1.distance &gt; t1.xtr_radius</span>
<span class="s">               )</span>
<span class="s">&quot;&quot;&quot;</span>

    <span class="n">qry_params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;imgid&#39;</span><span class="p">:</span><span class="n">image_id</span><span class="p">}</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">qry_params</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">n_deleted</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="k">if</span> <span class="n">n_deleted</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Removed </span><span class="si">%s</span><span class="s"> bad blind extractions for image </span><span class="si">%s</span><span class="s">&quot;</span>
                     <span class="s">&quot;(centred outside extraction region)&quot;</span><span class="p">,</span>
                     <span class="n">n_deleted</span><span class="p">,</span> <span class="n">image_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n_deleted</span>

</div>
<div class="viewcode-block" id="_empty_temprunningcatalog"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._empty_temprunningcatalog">[docs]</a><span class="k">def</span> <span class="nf">_empty_temprunningcatalog</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Initialize the temporary storage table</span>

<span class="sd">    Initialize the temporary table temprunningcatalog which contains</span>
<span class="sd">    the current observed sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM temprunningcatalog&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="_check_meridian_wrap"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._check_meridian_wrap">[docs]</a><span class="k">def</span> <span class="nf">_check_meridian_wrap</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks whether an image is close to the meridian ra = 0 or ra = 360</span>

<span class="sd">    When so, the association query needs to be rewritten to take into account</span>
<span class="sd">    sources across the 0/360 meridian.</span>

<span class="sd">    The query returns:</span>

<span class="sd">    q_across: true, if the extraction region of the image crosses</span>
<span class="sd">              the ra=0/360 border</span>

<span class="sd">    ra_min:   the min value of the ra-between for the normal case,</span>
<span class="sd">              when the image is outside the ra=0/360 meridian,</span>
<span class="sd">              otherwise NULL</span>

<span class="sd">    ra_max:   the max value of the ra-between for the normal case,</span>
<span class="sd">              when the image is outside the ra=0/360 meridian,</span>
<span class="sd">              otherwise NULL</span>

<span class="sd">    ra_min1/max1 and ra_min2/max2 are the values which may be used</span>
<span class="sd">    for the case of a cross-meridian image.</span>
<span class="sd">    F.ex. using a search radius of 5 degrees, and when a source is at</span>
<span class="sd">    359.99 the ra-betweens 1 and 2 are :</span>
<span class="sd">    ... AND (ra BETWEEN ra_min1 AND ra_max1 OR ra BETWEEN ra_min2 AND ra_max2) ...</span>
<span class="sd">    ... AND (ra BETWEEN 354.99 AND 360 OR ra BETWEEN 0 AND 4.99) ...</span>

<span class="sd">    ra_min1:  the min value of the high-end ra-between, if the</span>
<span class="sd">              extraction region of the image crosses the ra=0/360 border,</span>
<span class="sd">              otherwise NULL</span>

<span class="sd">    ra_max1:  the min value of the high-end ra-between, if the</span>
<span class="sd">              extraction region of the image crosses the ra=0/360 border,</span>
<span class="sd">              otherwise NULL</span>

<span class="sd">    ra_min2, ra_max2: As ra_min1/max1, but for the low-end ra values.</span>

<span class="sd">    These values are not being used in the cross-meridian association query,</span>
<span class="sd">    but are merely reported to notice the search area.</span>
<span class="sd">    The cross-meridian association query uses the cartesian dot product,</span>
<span class="sd">    to get the search area.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">meridian_wrap_query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">SELECT CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &lt; 0 OR</span>
<span class="s">                 s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &gt; 360</span>
<span class="s">            THEN TRUE</span>
<span class="s">            ELSE FALSE</span>
<span class="s">       END AS q_across</span>
<span class="s">      ,CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &gt; 0 AND</span>
<span class="s">                 s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &lt; 360</span>
<span class="s">            THEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl)</span>
<span class="s">            ELSE NULL</span>
<span class="s">       END AS ra_min</span>
<span class="s">      ,CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &gt; 0 AND</span>
<span class="s">                 s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &lt; 360</span>
<span class="s">            THEN s.centre_ra + alpha(s.xtr_radius, s.centre_decl)</span>
<span class="s">            ELSE NULL</span>
<span class="s">       END AS ra_max</span>
<span class="s">      ,CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &lt; 0</span>
<span class="s">            THEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) + 360.0</span>
<span class="s">            ELSE CASE WHEN s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &gt; 360</span>
<span class="s">                      THEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl)</span>
<span class="s">                      ELSE NULL</span>
<span class="s">                 END</span>
<span class="s">       END AS ra_min1</span>
<span class="s">      ,CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &lt; 0 OR</span>
<span class="s">                 s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &gt; 360</span>
<span class="s">            THEN 360</span>
<span class="s">            ELSE NULL</span>
<span class="s">       END AS ra_max1</span>
<span class="s">      ,CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &lt; 0 OR</span>
<span class="s">                 s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &gt; 360</span>
<span class="s">            THEN 0</span>
<span class="s">            ELSE NULL</span>
<span class="s">       END AS ra_min2</span>
<span class="s">      ,CASE WHEN s.centre_ra - alpha(s.xtr_radius, s.centre_decl) &lt; 0</span>
<span class="s">            THEN s.centre_ra + alpha(s.xtr_radius, s.centre_decl)</span>
<span class="s">            ELSE CASE WHEN s.centre_ra + alpha(s.xtr_radius, s.centre_decl) &gt; 360</span>
<span class="s">                      THEN s.centre_ra + alpha(s.xtr_radius, s.centre_decl) - 360</span>
<span class="s">                      ELSE NULL</span>
<span class="s">                 END</span>
<span class="s">       END AS ra_max2</span>
<span class="s">  FROM image i</span>
<span class="s">      ,skyregion s</span>
<span class="s"> WHERE i.skyrgn = s.id</span>
<span class="s">   AND i.id = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">}</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">meridian_wrap_query</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q_across</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ra_min</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ra_max</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ra_min1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">ra_max1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">ra_min2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">ra_max2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_across</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;More than one FoVs for image &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">image_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No FoV information present for image &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">image_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;q_across&#39;</span><span class="p">:</span> <span class="n">q_across</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;ra_min&#39;</span><span class="p">:</span> <span class="n">ra_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;ra_max&#39;</span><span class="p">:</span> <span class="n">ra_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;ra_min1&#39;</span><span class="p">:</span> <span class="n">ra_min1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;ra_max1&#39;</span><span class="p">:</span> <span class="n">ra_max1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;ra_min2&#39;</span><span class="p">:</span> <span class="n">ra_min2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s">&#39;ra_max2&#39;</span><span class="p">:</span> <span class="n">ra_max2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">}</span>

</div>
<div class="viewcode-block" id="_insert_temprunningcatalog"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_temprunningcatalog">[docs]</a><span class="k">def</span> <span class="nf">_insert_temprunningcatalog</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">deRuiter_r</span><span class="p">,</span> <span class="n">mw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select matched sources</span>

<span class="sd">    Here we select the extractedsource that have a positional match</span>
<span class="sd">    with the sources in the running catalogue table (runningcatalog).</span>
<span class="sd">    Those sources which *do* have a potential match, will be inserted into the</span>
<span class="sd">    temporary running catalogue table (temprunningcatalog).</span>

<span class="sd">    See also:</span>
<span class="sd">    http://docs.transientskp.org/tkp/database/schema.html#temprunningcatalog</span>

<span class="sd">    Explanation of some column name prefixes/suffixes used in the SQL query:</span>

<span class="sd">    - avg_X := average of X</span>
<span class="sd">    - avg_X_sq := average of X^2</span>
<span class="sd">    - avg_weight_X := average of weight of X, i.e. mean( 1/error^2 )</span>
<span class="sd">    - avg_weighted_X := average of weighted X,</span>
<span class="sd">         i.e. mean(X/error^2)</span>
<span class="sd">    - avg_weighted_X_sq := average of weighted X^2,</span>
<span class="sd">         i.e. mean(X^2/error^2)</span>

<span class="sd">    This result set might contain multiple associations (1-n,n-1)</span>
<span class="sd">    for a single known source in runningcatalog.</span>

<span class="sd">    The n-1 assocs will be treated similar as n 1-1 assocs.</span>

<span class="sd">    NOTE: Beware of the extra condition on x0.image in the WHERE clause,</span>
<span class="sd">    preventing the query to grow exponentially in response time</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># The cross-meridian differs slightly from the normal association query.</span>
    <span class="c">#</span>
    <span class="c"># We removed the wm_ra between statement, because the dot-product of the</span>
    <span class="c"># cartesian coordinates will handle the distance checking in case of</span>
    <span class="c"># meridian wrapping.</span>
    <span class="c">#</span>
    <span class="c"># The RA values for sources with 270 &lt; wm_ra &lt; 90 are translated to the</span>
    <span class="c"># opposite site of the sphere, where we can easily work with the modulo</span>
    <span class="c"># values to calculate the ra position (but this is of course translated</span>
    <span class="c"># back) and de Ruiter radius.</span>
    <span class="c">#</span>
    <span class="c"># Note that a weighted mean RA in the range [-8e-14, 0) is snapped to</span>
    <span class="c"># zero. This accounts for dynamic range issues with doubles: if we end up</span>
    <span class="c"># with a tiny sub-zero RA and add 360 to it, we end up with 360 rather</span>
    <span class="c"># than 359.999..., but, of course, we don&#39;t regard an RA of 360 as</span>
    <span class="c"># meaningful.</span>
    <span class="n">q_across_ra0</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO temprunningcatalog</span>
<span class="s">  (runcat</span>
<span class="s">  ,xtrsrc</span>
<span class="s">  ,distance_arcsec</span>
<span class="s">  ,r</span>
<span class="s">  ,dataset</span>
<span class="s">  ,band</span>
<span class="s">  ,stokes</span>
<span class="s">  ,datapoints</span>
<span class="s">  ,zone</span>
<span class="s">  ,wm_ra</span>
<span class="s">  ,wm_decl</span>
<span class="s">  ,wm_uncertainty_ew</span>
<span class="s">  ,wm_uncertainty_ns</span>
<span class="s">  ,avg_ra_err</span>
<span class="s">  ,avg_decl_err</span>
<span class="s">  ,avg_wra</span>
<span class="s">  ,avg_wdecl</span>
<span class="s">  ,avg_weight_ra</span>
<span class="s">  ,avg_weight_decl</span>
<span class="s">  ,x</span>
<span class="s">  ,y</span>
<span class="s">  ,z</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  ,avg_f_peak</span>
<span class="s">  ,avg_f_peak_sq</span>
<span class="s">  ,avg_f_peak_weight</span>
<span class="s">  ,avg_weighted_f_peak</span>
<span class="s">  ,avg_weighted_f_peak_sq</span>
<span class="s">  ,avg_f_int</span>
<span class="s">  ,avg_f_int_sq</span>
<span class="s">  ,avg_f_int_weight</span>
<span class="s">  ,avg_weighted_f_int</span>
<span class="s">  ,avg_weighted_f_int_sq</span>
<span class="s">  )</span>
<span class="s">  SELECT t0.runcat</span>
<span class="s">        ,t0.xtrsrc</span>
<span class="s">        ,t0.distance_arcsec</span>
<span class="s">        ,t0.r</span>
<span class="s">        ,t0.dataset</span>
<span class="s">        ,t0.band</span>
<span class="s">        ,t0.stokes</span>
<span class="s">        ,t0.datapoints</span>
<span class="s">        ,CAST(FLOOR(t0.wm_decl) AS INTEGER) AS zone</span>
<span class="s">        ,CASE WHEN t0.wm_ra &lt; 0</span>
<span class="s">              THEN CASE WHEN ABS(t0.wm_ra) &gt; 8e-14</span>
<span class="s">                        THEN t0.wm_ra + 360</span>
<span class="s">                        ELSE 0.0</span>
<span class="s">                   END</span>
<span class="s">              ELSE t0.wm_ra</span>
<span class="s">         END AS wm_ra</span>
<span class="s">        ,t0.wm_decl</span>
<span class="s">        ,t0.wm_uncertainty_ew</span>
<span class="s">        ,t0.wm_uncertainty_ns</span>
<span class="s">        ,t0.avg_ra_err</span>
<span class="s">        ,t0.avg_decl_err</span>
<span class="s">        ,t0.avg_wra</span>
<span class="s">        ,t0.avg_wdecl</span>
<span class="s">        ,t0.avg_weight_ra</span>
<span class="s">        ,t0.avg_weight_decl</span>
<span class="s">        ,COS(RADIANS(t0.wm_decl)) * COS(RADIANS(t0.wm_ra)) AS x</span>
<span class="s">        ,COS(RADIANS(t0.wm_decl)) * SIN(RADIANS(t0.wm_ra)) AS y</span>
<span class="s">        ,SIN(RADIANS(t0.wm_decl)) AS z</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN 1</span>
<span class="s">              ELSE rf0.f_datapoints + 1</span>
<span class="s">         END AS f_datapoints</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_peak</span>
<span class="s">                    + t0.f_peak)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_peak</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak * t0.f_peak</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_peak_sq</span>
<span class="s">                    + t0.f_peak * t0.f_peak)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_peak_sq</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN 1 / (t0.f_peak_err * t0.f_peak_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_peak_weight</span>
<span class="s">                    + 1 / (t0.f_peak_err * t0.f_peak_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_peak_weight</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak / (t0.f_peak_err * t0.f_peak_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_peak</span>
<span class="s">                    + t0.f_peak / (t0.f_peak_err * t0.f_peak_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_peak</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak * t0.f_peak / (t0.f_peak_err * t0.f_peak_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_peak_sq</span>
<span class="s">                    + (t0.f_peak * t0.f_peak) / (t0.f_peak_err * t0.f_peak_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_peak_sq</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_int</span>
<span class="s">                    + t0.f_int)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_int</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int * t0.f_int</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_int_sq</span>
<span class="s">                    + t0.f_int * t0.f_int)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_int_sq</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN 1 / (t0.f_int_err * t0.f_int_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_int_weight</span>
<span class="s">                    + 1 / (t0.f_int_err * t0.f_int_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_int_weight</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int / (t0.f_int_err * t0.f_int_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_int</span>
<span class="s">                    + t0.f_int / (t0.f_int_err * t0.f_int_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_int</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int * t0.f_int / (t0.f_int_err * t0.f_int_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_int_sq</span>
<span class="s">                    + (t0.f_int * t0.f_int) / (t0.f_int_err * t0.f_int_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_int_sq</span>
<span class="s">    FROM (SELECT rc0.id as runcat</span>
<span class="s">                ,x0.id as xtrsrc</span>
<span class="s">                ,3600 * DEGREES(2 * ASIN(SQRT( (rc0.x - x0.x) * (rc0.x - x0.x)</span>
<span class="s">                                             + (rc0.y - x0.y) * (rc0.y - x0.y)</span>
<span class="s">                                             + (rc0.z - x0.z) * (rc0.z - x0.z)</span>
<span class="s">                                             ) / 2)</span>
<span class="s">                               ) AS distance_arcsec</span>
<span class="s">                ,CASE WHEN rc0.wm_ra &lt; 90 OR rc0.wm_ra &gt; 270</span>
<span class="s">                      THEN</span>
<span class="s">                           SQRT(  (MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) - MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360)) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                                 * (MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) - MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360)) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                                 / (rc0.wm_uncertainty_ew * rc0.wm_uncertainty_ew + x0.uncertainty_ew * x0.uncertainty_ew)</span>
<span class="s">                                 + (rc0.wm_decl - x0.decl) * (rc0.wm_decl - x0.decl)</span>
<span class="s">                                 / (rc0.wm_uncertainty_ns * rc0.wm_uncertainty_ns + x0.uncertainty_ns * x0.uncertainty_ns)</span>
<span class="s">                               )</span>
<span class="s">                      ELSE</span>
<span class="s">                           SQRT(  (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                                 * (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                                 / (rc0.wm_uncertainty_ew * rc0.wm_uncertainty_ew + x0.uncertainty_ew * x0.uncertainty_ew)</span>
<span class="s">                                 +  (rc0.wm_decl - x0.decl) * (rc0.wm_decl - x0.decl)</span>
<span class="s">                                 / (rc0.wm_uncertainty_ns * rc0.wm_uncertainty_ns + x0.uncertainty_ns * x0.uncertainty_ns)</span>
<span class="s">                                )</span>
<span class="s">                 END AS r</span>
<span class="s">                ,x0.f_peak</span>
<span class="s">                ,x0.f_peak_err</span>
<span class="s">                ,x0.f_int</span>
<span class="s">                ,x0.f_int_err</span>
<span class="s">                ,i0.dataset</span>
<span class="s">                ,i0.band</span>
<span class="s">                ,i0.stokes</span>
<span class="s">                ,rc0.datapoints + 1 AS datapoints</span>
<span class="s">                ,CASE WHEN rc0.wm_ra &lt; 90 OR rc0.wm_ra &gt; 270</span>
<span class="s">                      THEN (datapoints * rc0.avg_weight_ra * MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) + MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360) / (x0.uncertainty_ew * x0.uncertainty_ew) )</span>
<span class="s">                           /</span>
<span class="s">                           (datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew) ) - 180</span>
<span class="s">                      ELSE</span>
<span class="s">                           (datapoints * rc0.avg_wra + x0.ra /(x0.uncertainty_ew * x0.uncertainty_ew) )</span>
<span class="s">                           /</span>
<span class="s">                           (datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew) )</span>
<span class="s">                 END AS wm_ra</span>
<span class="s">                ,(datapoints * rc0.avg_weight_decl * rc0.wm_decl + x0.decl / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 /</span>
<span class="s">                 (datapoints * rc0.avg_weight_decl + 1 / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 AS wm_decl</span>
<span class="s">                ,SQRT(1 / ((datapoints + 1) *</span>
<span class="s">                  ((datapoints * rc0.avg_weight_ra +</span>
<span class="s">                    1 / (x0.uncertainty_ew * x0.uncertainty_ew)) / (datapoints + 1))</span>
<span class="s">                          )</span>
<span class="s">                     ) AS wm_uncertainty_ew</span>
<span class="s">                ,SQRT(1 / ((datapoints + 1) *</span>
<span class="s">                  ((datapoints * rc0.avg_weight_decl +</span>
<span class="s">                    1 / (x0.uncertainty_ns * x0.uncertainty_ns)) / (datapoints + 1))</span>
<span class="s">                          )</span>
<span class="s">                     ) AS wm_uncertainty_ns</span>
<span class="s">                ,(datapoints * rc0.avg_ra_err + x0.ra_err) / (datapoints + 1) AS avg_ra_err</span>
<span class="s">                ,(datapoints * rc0.avg_decl_err + x0.decl_err) / (datapoints + 1) AS avg_decl_err</span>
<span class="s">                ,CASE WHEN rc0.wm_ra &lt; 90 OR rc0.wm_ra &gt; 270</span>
<span class="s">                      THEN ((datapoints * rc0.avg_weight_ra * MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) + MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360) / (x0.uncertainty_ew * x0.uncertainty_ew)</span>
<span class="s">                              - datapoints * avg_weight_ra * 180 - 180 / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                              / (datapoints + 1))</span>
<span class="s">                            - 360 * (datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew)) / (datapoints + 1)</span>
<span class="s">                            * FLOOR(</span>
<span class="s">                               ((datapoints * avg_weight_ra * MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) + MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360) / (x0.uncertainty_ew * x0.uncertainty_ew)</span>
<span class="s">                                 - datapoints * avg_weight_ra * 180 - 180 / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                                 / (datapoints + 1))</span>
<span class="s">                               / (360 * (datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew)) / (datapoints + 1))</span>
<span class="s">                               )</span>
<span class="s">                      ELSE</span>
<span class="s">                            (datapoints * rc0.avg_wra + x0.ra / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                             / (datapoints + 1)</span>
<span class="s">                 END AS avg_wra</span>
<span class="s">                ,(datapoints * rc0.avg_wdecl + x0.decl / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 / (datapoints + 1) AS avg_wdecl</span>
<span class="s">                ,(datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                 / (datapoints + 1) AS avg_weight_ra</span>
<span class="s">                ,(datapoints * rc0.avg_weight_decl + 1 / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 / (datapoints + 1) AS avg_weight_decl</span>
<span class="s">            FROM extractedsource x0</span>
<span class="s">                ,runningcatalog rc0</span>
<span class="s">                ,image i0</span>
<span class="s">           WHERE i0.id = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">             AND x0.image = i0.id</span>
<span class="s">             AND x0.image = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">             AND i0.dataset = rc0.dataset</span>
<span class="s">             AND rc0.mon_src = FALSE</span>
<span class="s">             AND rc0.zone BETWEEN CAST(FLOOR(x0.decl - i0.rb_smaj) as INTEGER)</span>
<span class="s">                              AND CAST(FLOOR(x0.decl + i0.rb_smaj) as INTEGER)</span>
<span class="s">             AND rc0.wm_decl BETWEEN x0.decl - i0.rb_smaj</span>
<span class="s">                                 AND x0.decl + i0.rb_smaj</span>
<span class="s">             AND rc0.x*x0.x + rc0.y*x0.y + rc0.z*x0.z &gt; cos(radians(i0.rb_smaj))</span>
<span class="s">             AND CASE WHEN rc0.wm_ra &lt; 90 OR rc0.wm_ra &gt; 270</span>
<span class="s">                      THEN SQRT(  (MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) - MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360)) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                          * (MOD(CAST(rc0.wm_ra + 180 AS NUMERIC(11,8)), 360) - MOD(CAST(x0.ra + 180 AS NUMERIC(11,8)), 360)) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                          / (x0.uncertainty_ew * x0.uncertainty_ew + rc0.wm_uncertainty_ew * rc0.wm_uncertainty_ew)</span>
<span class="s">                          + (x0.decl - rc0.wm_decl) * (x0.decl - rc0.wm_decl)</span>
<span class="s">                          / (x0.uncertainty_ns * x0.uncertainty_ns + rc0.wm_uncertainty_ns * rc0.wm_uncertainty_ns)</span>
<span class="s">                         )</span>
<span class="s">                      ELSE SQRT(  (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                           * (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                           / (x0.uncertainty_ew * x0.uncertainty_ew + rc0.wm_uncertainty_ew * rc0.wm_uncertainty_ew)</span>
<span class="s">                           + (x0.decl - rc0.wm_decl) * (x0.decl - rc0.wm_decl)</span>
<span class="s">                           / (x0.uncertainty_ns * x0.uncertainty_ns + rc0.wm_uncertainty_ns * rc0.wm_uncertainty_ns)</span>
<span class="s">                          )</span>
<span class="s">                 END &lt; </span><span class="si">%(deRuiter)s</span><span class="s"></span>
<span class="s">         ) t0</span>
<span class="s">         LEFT OUTER JOIN runningcatalog_flux rf0</span>
<span class="s">         ON t0.runcat = rf0.runcat</span>
<span class="s">         AND t0.band = rf0.band</span>
<span class="s">         AND t0.stokes = rf0.stokes</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO temprunningcatalog</span>
<span class="s">  (runcat</span>
<span class="s">  ,xtrsrc</span>
<span class="s">  ,distance_arcsec</span>
<span class="s">  ,r</span>
<span class="s">  ,dataset</span>
<span class="s">  ,band</span>
<span class="s">  ,stokes</span>
<span class="s">  ,datapoints</span>
<span class="s">  ,zone</span>
<span class="s">  ,wm_ra</span>
<span class="s">  ,wm_decl</span>
<span class="s">  ,wm_uncertainty_ew</span>
<span class="s">  ,wm_uncertainty_ns</span>
<span class="s">  ,avg_ra_err</span>
<span class="s">  ,avg_decl_err</span>
<span class="s">  ,avg_wra</span>
<span class="s">  ,avg_wdecl</span>
<span class="s">  ,avg_weight_ra</span>
<span class="s">  ,avg_weight_decl</span>
<span class="s">  ,x</span>
<span class="s">  ,y</span>
<span class="s">  ,z</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  ,avg_f_peak</span>
<span class="s">  ,avg_f_peak_sq</span>
<span class="s">  ,avg_f_peak_weight</span>
<span class="s">  ,avg_weighted_f_peak</span>
<span class="s">  ,avg_weighted_f_peak_sq</span>
<span class="s">  ,avg_f_int</span>
<span class="s">  ,avg_f_int_sq</span>
<span class="s">  ,avg_f_int_weight</span>
<span class="s">  ,avg_weighted_f_int</span>
<span class="s">  ,avg_weighted_f_int_sq</span>
<span class="s">  )</span>
<span class="s">  SELECT t0.runcat</span>
<span class="s">        ,t0.xtrsrc</span>
<span class="s">        ,t0.distance_arcsec</span>
<span class="s">        ,t0.r</span>
<span class="s">        ,t0.dataset</span>
<span class="s">        ,t0.band</span>
<span class="s">        ,t0.stokes</span>
<span class="s">        ,t0.datapoints</span>
<span class="s">        ,CAST(FLOOR(t0.wm_decl) AS INTEGER) AS zone</span>
<span class="s">        ,t0.wm_ra</span>
<span class="s">        ,t0.wm_decl</span>
<span class="s">        ,t0.wm_uncertainty_ew</span>
<span class="s">        ,t0.wm_uncertainty_ns</span>
<span class="s">        ,t0.avg_ra_err</span>
<span class="s">        ,t0.avg_decl_err</span>
<span class="s">        ,t0.avg_wra</span>
<span class="s">        ,t0.avg_wdecl</span>
<span class="s">        ,t0.avg_weight_ra</span>
<span class="s">        ,t0.avg_weight_decl</span>
<span class="s">        ,COS(RADIANS(t0.wm_decl)) * COS(RADIANS(t0.wm_ra)) AS x</span>
<span class="s">        ,COS(RADIANS(t0.wm_decl)) * SIN(RADIANS(t0.wm_ra)) AS y</span>
<span class="s">        ,SIN(RADIANS(t0.wm_decl)) AS z</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN 1</span>
<span class="s">              ELSE rf0.f_datapoints + 1</span>
<span class="s">         END AS f_datapoints</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_peak</span>
<span class="s">                    + t0.f_peak)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_peak</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak * t0.f_peak</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_peak_sq</span>
<span class="s">                    + t0.f_peak * t0.f_peak)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_peak_sq</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN 1 / (t0.f_peak_err * t0.f_peak_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_peak_weight</span>
<span class="s">                    + 1 / (t0.f_peak_err * t0.f_peak_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_peak_weight</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak / (t0.f_peak_err * t0.f_peak_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_peak</span>
<span class="s">                    + t0.f_peak / (t0.f_peak_err * t0.f_peak_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_peak</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_peak * t0.f_peak / (t0.f_peak_err * t0.f_peak_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_peak_sq</span>
<span class="s">                    + (t0.f_peak * t0.f_peak) / (t0.f_peak_err * t0.f_peak_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_peak_sq</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_int</span>
<span class="s">                    + t0.f_int)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_int</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int * t0.f_int</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_int_sq</span>
<span class="s">                    + t0.f_int * t0.f_int)</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_int_sq</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN 1 / (t0.f_int_err * t0.f_int_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_f_int_weight</span>
<span class="s">                    + 1 / (t0.f_int_err * t0.f_int_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_f_int_weight</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int / (t0.f_int_err * t0.f_int_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_int</span>
<span class="s">                    + t0.f_int / (t0.f_int_err * t0.f_int_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_int</span>
<span class="s">        ,CASE WHEN rf0.f_datapoints IS NULL</span>
<span class="s">              THEN t0.f_int * t0.f_int / (t0.f_int_err * t0.f_int_err)</span>
<span class="s">              ELSE (rf0.f_datapoints * rf0.avg_weighted_f_int_sq</span>
<span class="s">                    + (t0.f_int * t0.f_int) / (t0.f_int_err * t0.f_int_err))</span>
<span class="s">                   / (rf0.f_datapoints + 1)</span>
<span class="s">         END AS avg_weighted_f_int_sq</span>
<span class="s">    FROM (SELECT rc0.id as runcat</span>
<span class="s">                ,x0.id as xtrsrc</span>
<span class="s">                ,3600 * DEGREES(2 * ASIN(SQRT( (rc0.x - x0.x) * (rc0.x - x0.x)</span>
<span class="s">                                             + (rc0.y - x0.y) * (rc0.y - x0.y)</span>
<span class="s">                                             + (rc0.z - x0.z) * (rc0.z - x0.z)</span>
<span class="s">                                             ) / 2)</span>
<span class="s">                               ) AS distance_arcsec</span>
<span class="s">                ,SQRT(  (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                      * (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                      / (rc0.wm_uncertainty_ew * rc0.wm_uncertainty_ew + x0.uncertainty_ew * x0.uncertainty_ew)</span>
<span class="s">                     +  (rc0.wm_decl - x0.decl) * (rc0.wm_decl - x0.decl)</span>
<span class="s">                      / (rc0.wm_uncertainty_ns * rc0.wm_uncertainty_ns + x0.uncertainty_ns * x0.uncertainty_ns)</span>
<span class="s">                     ) AS r</span>
<span class="s">                ,x0.f_peak</span>
<span class="s">                ,x0.f_peak_err</span>
<span class="s">                ,x0.f_int</span>
<span class="s">                ,x0.f_int_err</span>
<span class="s">                ,i0.dataset</span>
<span class="s">                ,i0.band</span>
<span class="s">                ,i0.stokes</span>
<span class="s">                ,rc0.datapoints + 1 AS datapoints</span>
<span class="s">                ,(datapoints * rc0.avg_wra + x0.ra /(x0.uncertainty_ew * x0.uncertainty_ew) )</span>
<span class="s">                 /</span>
<span class="s">                 (datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew) )</span>
<span class="s">                 AS wm_ra</span>
<span class="s">                ,(datapoints * rc0.avg_wdecl + x0.decl /(x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 /</span>
<span class="s">                 (datapoints * rc0.avg_weight_decl + 1 /(x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 AS wm_decl</span>
<span class="s">                , SQRT(1 / ((datapoints + 1)</span>
<span class="s">                           * ((datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                              / (datapoints + 1)</span>
<span class="s">                             )</span>
<span class="s">                           )</span>
<span class="s">                      ) AS wm_uncertainty_ew</span>
<span class="s">                , SQRT(1 / ((datapoints + 1)</span>
<span class="s">                           * ((datapoints * rc0.avg_weight_decl + 1 / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                              / (datapoints + 1)</span>
<span class="s">                             )</span>
<span class="s">                           )</span>
<span class="s">                      ) AS wm_uncertainty_ns</span>
<span class="s">                ,(datapoints * rc0.avg_ra_err + x0.ra_err) / (datapoints + 1) AS avg_ra_err</span>
<span class="s">                ,(datapoints * rc0.avg_decl_err + x0.decl_err) / (datapoints + 1) AS avg_decl_err</span>
<span class="s">                ,(datapoints * rc0.avg_wra + x0.ra / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                 / (datapoints + 1) AS avg_wra</span>
<span class="s">                ,(datapoints * rc0.avg_wdecl + x0.decl / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 / (datapoints + 1) AS avg_wdecl</span>
<span class="s">                ,(datapoints * rc0.avg_weight_ra + 1 / (x0.uncertainty_ew * x0.uncertainty_ew))</span>
<span class="s">                 / (datapoints + 1) AS avg_weight_ra</span>
<span class="s">                ,(datapoints * rc0.avg_weight_decl + 1 / (x0.uncertainty_ns * x0.uncertainty_ns))</span>
<span class="s">                 / (datapoints + 1) AS avg_weight_decl</span>
<span class="s">            FROM extractedsource x0</span>
<span class="s">                ,runningcatalog rc0</span>
<span class="s">                ,image i0</span>
<span class="s">           WHERE i0.id = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">             AND x0.image = i0.id</span>
<span class="s">             AND x0.image = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">             AND i0.dataset = rc0.dataset</span>
<span class="s">             AND rc0.mon_src = FALSE</span>
<span class="s">             AND rc0.zone BETWEEN CAST(FLOOR(x0.decl - i0.rb_smaj) AS INTEGER)</span>
<span class="s">                              AND CAST(FLOOR(x0.decl + i0.rb_smaj) AS INTEGER)</span>
<span class="s">             AND rc0.wm_decl BETWEEN x0.decl - i0.rb_smaj</span>
<span class="s">                                 AND x0.decl + i0.rb_smaj</span>
<span class="s">             AND rc0.wm_ra BETWEEN x0.ra - alpha(i0.rb_smaj, x0.decl)</span>
<span class="s">                               AND x0.ra + alpha(i0.rb_smaj, x0.decl)</span>
<span class="s">             AND rc0.x * x0.x + rc0.y * x0.y + rc0.z * x0.z &gt; COS(RADIANS(i0.rb_smaj))</span>
<span class="s">             AND SQRT(  (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                      * (rc0.wm_ra - x0.ra) * COS(RADIANS((rc0.wm_decl + x0.decl)/2))</span>
<span class="s">                      / (x0.uncertainty_ew * x0.uncertainty_ew + rc0.wm_uncertainty_ew * rc0.wm_uncertainty_ew)</span>
<span class="s">                     + (x0.decl - rc0.wm_decl) * (x0.decl - rc0.wm_decl)</span>
<span class="s">                      / (x0.uncertainty_ns * x0.uncertainty_ns + rc0.wm_uncertainty_ns * rc0.wm_uncertainty_ns)</span>
<span class="s">                     ) &lt; </span><span class="si">%(deRuiter)s</span><span class="s"></span>
<span class="s">         ) t0</span>
<span class="s">         LEFT OUTER JOIN runningcatalog_flux rf0</span>
<span class="s">         ON t0.runcat = rf0.runcat</span>
<span class="s">         AND t0.band = rf0.band</span>
<span class="s">         AND t0.stokes = rf0.stokes</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="c">#mw = _check_meridian_wrap(conn, image_id)</span>
    <span class="k">if</span> <span class="n">mw</span><span class="p">[</span><span class="s">&#39;q_across&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Search across 0/360 meridian: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mw</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">q_across_ra0</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span> <span class="s">&#39;deRuiter&#39;</span><span class="p">:</span> <span class="n">deRuiter_r</span><span class="p">}</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_flag_many_to_many_tempruncat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._flag_many_to_many_tempruncat">[docs]</a><span class="k">def</span> <span class="nf">_flag_many_to_many_tempruncat</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Select the many-to-many association pairs in temprunningcatalog.</span>

<span class="sd">    By flagging the many-to-many associations, we reduce the</span>
<span class="sd">    processing to one-to-many and many-to-one (identical to one-to-one)</span>
<span class="sd">    relationships</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># This one selects the farthest out of the many-to-many assocs</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">UPDATE temprunningcatalog</span>
<span class="s">   SET inactive = TRUE</span>
<span class="s"> WHERE EXISTS (SELECT runcat</span>
<span class="s">                     ,xtrsrc</span>
<span class="s">                 FROM (SELECT t1.runcat</span>
<span class="s">                             ,t1.xtrsrc</span>
<span class="s">                         FROM (SELECT xtrsrc</span>
<span class="s">                                     ,MIN(r) as min_r</span>
<span class="s">                                 FROM temprunningcatalog</span>
<span class="s">                                WHERE runcat IN (SELECT runcat</span>
<span class="s">                                                   FROM temprunningcatalog</span>
<span class="s">                                                  WHERE runcat IN (SELECT runcat</span>
<span class="s">                                                                     FROM temprunningcatalog</span>
<span class="s">                                                                    WHERE xtrsrc IN (SELECT xtrsrc</span>
<span class="s">                                                                                       FROM temprunningcatalog</span>
<span class="s">                                                                                     GROUP BY xtrsrc</span>
<span class="s">                                                                                     HAVING COUNT(*) &gt; 1</span>
<span class="s">                                                                                    )</span>
<span class="s">                                                                  )</span>
<span class="s">                                                 GROUP BY runcat</span>
<span class="s">                                                 HAVING COUNT(*) &gt; 1</span>
<span class="s">                                                )</span>
<span class="s">                                  AND xtrsrc IN (SELECT xtrsrc</span>
<span class="s">                                                   FROM temprunningcatalog</span>
<span class="s">                                                 GROUP BY xtrsrc</span>
<span class="s">                                                 HAVING COUNT(*) &gt; 1</span>
<span class="s">                                                )</span>
<span class="s">                               GROUP BY xtrsrc</span>
<span class="s">                              ) t0</span>
<span class="s">                             ,(SELECT runcat</span>
<span class="s">                                     ,xtrsrc</span>
<span class="s">                                     ,r</span>
<span class="s">                                 FROM temprunningcatalog</span>
<span class="s">                                WHERE runcat IN (SELECT runcat</span>
<span class="s">                                                   FROM temprunningcatalog</span>
<span class="s">                                                  WHERE runcat IN (SELECT runcat</span>
<span class="s">                                                                     FROM temprunningcatalog</span>
<span class="s">                                                                    WHERE xtrsrc IN (SELECT xtrsrc</span>
<span class="s">                                                                                       FROM temprunningcatalog</span>
<span class="s">                                                                                     GROUP BY xtrsrc</span>
<span class="s">                                                                                     HAVING COUNT(*) &gt; 1</span>
<span class="s">                                                                                    )</span>
<span class="s">                                                                  )</span>
<span class="s">                                                 GROUP BY runcat</span>
<span class="s">                                                 HAVING COUNT(*) &gt; 1</span>
<span class="s">                                                )</span>
<span class="s">                                  AND xtrsrc IN (SELECT xtrsrc</span>
<span class="s">                                                   FROM temprunningcatalog</span>
<span class="s">                                                 GROUP BY xtrsrc</span>
<span class="s">                                                 HAVING COUNT(*) &gt; 1</span>
<span class="s">                                                )</span>
<span class="s">                              ) t1</span>
<span class="s">                        WHERE t0.xtrsrc = t1.xtrsrc</span>
<span class="s">                          AND t0.min_r &lt; t1.r</span>
<span class="s">                      ) t2</span>
<span class="s">                WHERE t2.runcat = temprunningcatalog.runcat</span>
<span class="s">                  AND t2.xtrsrc = temprunningcatalog.xtrsrc</span>
<span class="s">              )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_many_runcat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_many_runcat">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_many_runcat</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Insert the extracted sources that belong to one-to-many</span>
<span class="sd">    associations in the runningcatalog.</span>

<span class="sd">    Since for the one-to-many associations (i.e. one runcat source</span>
<span class="sd">    associated with multiple extracted sources) we cannot a priori</span>
<span class="sd">    decide which counterpart pair is the correct one, or whether all</span>
<span class="sd">    are correct (in the case of a higher-resolution image),</span>
<span class="sd">    all extracted sources are added as a new source to</span>
<span class="sd">    the runningcatalog, and they will replace the (old; lower resolution)</span>
<span class="sd">    runcat source of the association.</span>

<span class="sd">    As a consequence of this, the resolution of the runningcatalog</span>
<span class="sd">    is increasing over time.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO runningcatalog</span>
<span class="s">  (xtrsrc</span>
<span class="s">  ,dataset</span>
<span class="s">  ,datapoints</span>
<span class="s">  ,zone</span>
<span class="s">  ,wm_ra</span>
<span class="s">  ,wm_decl</span>
<span class="s">  ,wm_uncertainty_ew</span>
<span class="s">  ,wm_uncertainty_ns</span>
<span class="s">  ,avg_ra_err</span>
<span class="s">  ,avg_decl_err</span>
<span class="s">  ,avg_wra</span>
<span class="s">  ,avg_wdecl</span>
<span class="s">  ,avg_weight_ra</span>
<span class="s">  ,avg_weight_decl</span>
<span class="s">  ,x</span>
<span class="s">  ,y</span>
<span class="s">  ,z</span>
<span class="s">  )</span>
<span class="s">  SELECT xtrsrc</span>
<span class="s">        ,dataset</span>
<span class="s">        ,datapoints</span>
<span class="s">        ,zone</span>
<span class="s">        ,wm_ra</span>
<span class="s">        ,wm_decl</span>
<span class="s">        ,wm_uncertainty_ew</span>
<span class="s">        ,wm_uncertainty_ns</span>
<span class="s">        ,avg_ra_err</span>
<span class="s">        ,avg_decl_err</span>
<span class="s">        ,avg_wra</span>
<span class="s">        ,avg_wdecl</span>
<span class="s">        ,avg_weight_ra</span>
<span class="s">        ,avg_weight_decl</span>
<span class="s">        ,x</span>
<span class="s">        ,y</span>
<span class="s">        ,z</span>
<span class="s">    FROM (SELECT runcat</span>
<span class="s">            FROM temprunningcatalog</span>
<span class="s">           WHERE inactive = FALSE</span>
<span class="s">          GROUP BY runcat</span>
<span class="s">          HAVING COUNT(*) &gt; 1</span>
<span class="s">         ) one_to_many</span>
<span class="s">        ,temprunningcatalog tmprc</span>
<span class="s">   WHERE tmprc.runcat = one_to_many.runcat</span>
<span class="s">     AND tmprc.inactive = FALSE</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_many_runcat_flux"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_many_runcat_flux">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_many_runcat_flux</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Insert the fluxes of the extracted sources that belong</span>
<span class="sd">    to a one-to-many association in the runningcatalog.</span>

<span class="sd">    Analogous to the runningcatalog, extracted source properties</span>
<span class="sd">    are added to the runningcatalog_flux table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># NB we pull the new runcat id from the runningcatalog by matching with</span>
    <span class="c"># temprunningcatalog via xtrsrc. (temprunningcatalog.runcat points at old</span>
    <span class="c"># runcat entries).</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO runningcatalog_flux</span>
<span class="s">  (runcat</span>
<span class="s">  ,band</span>
<span class="s">  ,stokes</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  ,avg_f_peak</span>
<span class="s">  ,avg_f_peak_sq</span>
<span class="s">  ,avg_f_peak_weight</span>
<span class="s">  ,avg_weighted_f_peak</span>
<span class="s">  ,avg_weighted_f_peak_sq</span>
<span class="s">  ,avg_f_int</span>
<span class="s">  ,avg_f_int_sq</span>
<span class="s">  ,avg_f_int_weight</span>
<span class="s">  ,avg_weighted_f_int</span>
<span class="s">  ,avg_weighted_f_int_sq</span>
<span class="s">  )</span>
<span class="s">  SELECT r.id</span>
<span class="s">        ,tmprc.band</span>
<span class="s">        ,tmprc.stokes</span>
<span class="s">        ,tmprc.f_datapoints</span>
<span class="s">        ,avg_f_peak</span>
<span class="s">        ,avg_f_peak_sq</span>
<span class="s">        ,avg_f_peak_weight</span>
<span class="s">        ,avg_weighted_f_peak</span>
<span class="s">        ,avg_weighted_f_peak_sq</span>
<span class="s">        ,avg_f_int</span>
<span class="s">        ,avg_f_int_sq</span>
<span class="s">        ,avg_f_int_weight</span>
<span class="s">        ,avg_weighted_f_int</span>
<span class="s">        ,avg_weighted_f_int_sq</span>
<span class="s">    FROM (SELECT runcat</span>
<span class="s">            FROM temprunningcatalog</span>
<span class="s">           WHERE inactive = FALSE</span>
<span class="s">          GROUP BY runcat</span>
<span class="s">          HAVING COUNT(*) &gt; 1</span>
<span class="s">         ) one_to_many</span>
<span class="s">        ,temprunningcatalog tmprc</span>
<span class="s">        ,runningcatalog r</span>
<span class="s">   WHERE tmprc.runcat = one_to_many.runcat</span>
<span class="s">     AND tmprc.inactive = FALSE</span>
<span class="s">     AND r.xtrsrc = tmprc.xtrsrc</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_many_basepoint_assocxtrsource"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_many_basepoint_assocxtrsource">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_many_basepoint_assocxtrsource</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Insert &#39;base points&#39; for one-to-many associations</span>

<span class="sd">    Before continuing, we have to insert the &#39;base points&#39; of the associations,</span>
<span class="sd">    i.e. the links between the new runningcatalog entries</span>
<span class="sd">    and their associated (new) extractedsources.</span>

<span class="sd">    We also calculate the variability indices at the timestamp of the</span>
<span class="sd">    the current image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># NB we pull the new runcat id from the runningcatalog by matching with</span>
    <span class="c"># temprunningcatalog via xtrsrc. (temprunningcatalog.runcat points at old</span>
    <span class="c"># runcat entries).</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocxtrsource</span>
<span class="s">  (runcat</span>
<span class="s">  ,xtrsrc</span>
<span class="s">  ,type</span>
<span class="s">  ,distance_arcsec</span>
<span class="s">  ,r</span>
<span class="s">  ,v_int</span>
<span class="s">  ,eta_int</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  )</span>
<span class="s">  SELECT t0.new_runcat_id</span>
<span class="s">        ,t0.xtrsrc</span>
<span class="s">        ,2</span>
<span class="s">        ,t0.distance_arcsec</span>
<span class="s">        ,t0.r</span>
<span class="s">        ,t0.v_int_inter / t0.avg_f_int</span>
<span class="s">        ,t0.eta_int_inter / t0.avg_f_int_weight</span>
<span class="s">        ,t0.f_datapoints</span>
<span class="s">    FROM (SELECT runcat.id AS new_runcat_id</span>
<span class="s">                ,tmprc.xtrsrc</span>
<span class="s">                ,tmprc.distance_arcsec</span>
<span class="s">                ,tmprc.r</span>
<span class="s">                ,tmprc.f_datapoints</span>
<span class="s">                ,CASE WHEN tmprc.avg_f_int = 0.0</span>
<span class="s">                      THEN 0.000001</span>
<span class="s">                      ELSE avg_f_int</span>
<span class="s">                 END AS avg_f_int</span>
<span class="s">                ,tmprc.avg_f_int_weight</span>
<span class="s">                ,CASE WHEN tmprc.f_datapoints = 1</span>
<span class="s">                      THEN 0</span>
<span class="s">                      ELSE CASE WHEN ABS(tmprc.avg_f_int_sq - tmprc.avg_f_int * tmprc.avg_f_int) &lt; 8e-14</span>
<span class="s">                                THEN 0</span>
<span class="s">                                ELSE SQRT(CAST(tmprc.f_datapoints AS DOUBLE PRECISION)</span>
<span class="s">                                         * (tmprc.avg_f_int_sq - tmprc.avg_f_int * tmprc.avg_f_int)</span>
<span class="s">                                         / (CAST(tmprc.f_datapoints AS DOUBLE PRECISION) - 1.0)</span>
<span class="s">                                         )</span>
<span class="s">                           END</span>
<span class="s">                 END AS v_int_inter</span>
<span class="s">                ,CASE WHEN tmprc.f_datapoints = 1</span>
<span class="s">                      THEN 0</span>
<span class="s">                      ELSE (CAST(tmprc.f_datapoints AS DOUBLE PRECISION) /</span>
<span class="s">                              (CAST(tmprc.f_datapoints AS DOUBLE PRECISION) - 1.0))</span>
<span class="s">                           * (tmprc.avg_f_int_weight * tmprc.avg_weighted_f_int_sq -</span>
<span class="s">                                  tmprc.avg_weighted_f_int * tmprc.avg_weighted_f_int)</span>
<span class="s">                 END AS eta_int_inter</span>
<span class="s">            FROM (SELECT runcat as old_runcat_id</span>
<span class="s">                    FROM temprunningcatalog</span>
<span class="s">                   WHERE inactive = FALSE</span>
<span class="s">                  GROUP BY runcat</span>
<span class="s">                  HAVING COUNT(*) &gt; 1</span>
<span class="s">                 ) one_to_many</span>
<span class="s">                ,temprunningcatalog tmprc</span>
<span class="s">                ,runningcatalog runcat</span>
<span class="s">           WHERE tmprc.runcat = one_to_many.old_runcat_id</span>
<span class="s">             AND tmprc.inactive = FALSE</span>
<span class="s">             AND runcat.xtrsrc = tmprc.xtrsrc</span>
<span class="s">         ) t0</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_many_replacement_assocxtrsource"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_many_replacement_assocxtrsource">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_many_replacement_assocxtrsource</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Insert links into the association table between the new runcat</span>
<span class="sd">    entries and the old extractedsources.</span>
<span class="sd">    (New to New (&#39;basepoint&#39;) links have been added earlier).</span>

<span class="sd">    In this case, new entries in the runningcatalog and runningcatalog_flux</span>
<span class="sd">    were already added (for every extractedsource one), which will replace</span>
<span class="sd">    the existing ones in the runningcatalog.</span>
<span class="sd">    Therefore, we have to update the references to these new ids as well.</span>
<span class="sd">    So, we will append to assocxtrsource and delete the entries from</span>
<span class="sd">    runningcatalog_flux.</span>

<span class="sd">    NOTE:</span>
<span class="sd">    1. We do not update the distance_arcsec and r values of the pairs.</span>

<span class="sd">    TODO:</span>
<span class="sd">    1. Why not?</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c"># NB we pull the new runcat id from the runningcatalog by matching with</span>
    <span class="c"># temprunningcatalog via xtrsrc. (temprunningcatalog.runcat points at old</span>
    <span class="c"># runcat entries).</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocxtrsource</span>
<span class="s">  (runcat</span>
<span class="s">  ,xtrsrc</span>
<span class="s">  ,type</span>
<span class="s">  ,distance_arcsec</span>
<span class="s">  ,r</span>
<span class="s">  ,v_int</span>
<span class="s">  ,eta_int</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  )</span>
<span class="s">  SELECT r.id AS new_runcat_id</span>
<span class="s">        ,a.xtrsrc</span>
<span class="s">        ,6</span>
<span class="s">        ,a.distance_arcsec</span>
<span class="s">        ,a.r</span>
<span class="s">        ,a.v_int</span>
<span class="s">        ,a.eta_int</span>
<span class="s">        ,a.f_datapoints</span>
<span class="s">    FROM (SELECT runcat as old_runcat_id</span>
<span class="s">            FROM temprunningcatalog</span>
<span class="s">           WHERE inactive = FALSE</span>
<span class="s">          GROUP BY runcat</span>
<span class="s">          HAVING COUNT(*) &gt; 1</span>
<span class="s">         ) one_to_many</span>
<span class="s">        ,temprunningcatalog tmprc</span>
<span class="s">        ,runningcatalog r</span>
<span class="s">        ,assocxtrsource a</span>
<span class="s">   WHERE tmprc.runcat = one_to_many.old_runcat_id</span>
<span class="s">     AND tmprc.inactive = FALSE</span>
<span class="s">     AND r.xtrsrc = tmprc.xtrsrc</span>
<span class="s">     AND a.runcat = tmprc.runcat</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_many_assocskyrgn"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_many_assocskyrgn">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_many_assocskyrgn</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy skyregion associations from old runcat entries for new one-to-many</span>
<span class="sd">    runningcatalog entries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># NB we pull the new runcat id from the runningcatalog by matching with</span>
    <span class="c"># temprunningcatalog via xtrsrc. (temprunningcatalog.runcat points at old</span>
    <span class="c"># runcat entries).</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocskyrgn</span>
<span class="s">  (runcat</span>
<span class="s">  ,skyrgn</span>
<span class="s">  ,distance_deg</span>
<span class="s">  )</span>
<span class="s">  SELECT r.id AS new_runcat_id</span>
<span class="s">        ,a.skyrgn</span>
<span class="s">        ,a.distance_deg</span>
<span class="s">    FROM (SELECT runcat as old_runcat_id</span>
<span class="s">            FROM temprunningcatalog</span>
<span class="s">           WHERE inactive = FALSE</span>
<span class="s">          GROUP BY runcat</span>
<span class="s">          HAVING COUNT(*) &gt; 1</span>
<span class="s">         ) one_to_many</span>
<span class="s">        ,temprunningcatalog tmprc</span>
<span class="s">        ,runningcatalog r</span>
<span class="s">        ,assocskyrgn a</span>
<span class="s">   WHERE tmprc.runcat = one_to_many.old_runcat_id</span>
<span class="s">     AND tmprc.inactive = FALSE</span>
<span class="s">     AND r.xtrsrc = tmprc.xtrsrc</span>
<span class="s">     AND a.runcat = tmprc.runcat</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_many_transient"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_many_transient">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_many_transient</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Update the runcat id for the one-to-many associations,</span>
<span class="sd">    and delete the transient entries of the old runcat id</span>
<span class="sd">    (the new ones have been added earlier).</span>

<span class="sd">    In this case, new entries in the runningcatalog and runningcatalog_flux</span>
<span class="sd">    were already added (for every extractedsource one), which will replace</span>
<span class="sd">    the existing ones in the runningcatalog.</span>
<span class="sd">    Therefore, we have to update the references to these new ids as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO transient</span>
<span class="s">  (runcat</span>
<span class="s">  ,band</span>
<span class="s">  ,siglevel</span>
<span class="s">  ,v_int</span>
<span class="s">  ,eta_int</span>
<span class="s">  ,detection_level</span>
<span class="s">  ,trigger_xtrsrc</span>
<span class="s">  ,status</span>
<span class="s">  ,t_start</span>
<span class="s">  ,transient_type</span>
<span class="s">  ,previous_limits_image</span>
<span class="s">  )</span>
<span class="s">  SELECT r.id as new_runcat_id</span>
<span class="s">        ,tr.band</span>
<span class="s">        ,tr.siglevel</span>
<span class="s">        ,tr.v_int</span>
<span class="s">        ,tr.eta_int</span>
<span class="s">        ,tr.detection_level</span>
<span class="s">        ,tr.trigger_xtrsrc</span>
<span class="s">        ,tr.status</span>
<span class="s">        ,tr.t_start</span>
<span class="s">        ,tr.transient_type</span>
<span class="s">        ,tr.previous_limits_image</span>
<span class="s">    FROM (SELECT runcat as old_runcat_id</span>
<span class="s">            FROM temprunningcatalog</span>
<span class="s">           WHERE inactive = FALSE</span>
<span class="s">          GROUP BY runcat</span>
<span class="s">          HAVING COUNT(*) &gt; 1</span>
<span class="s">         ) one_to_many</span>
<span class="s">        ,temprunningcatalog tmprc</span>
<span class="s">        ,runningcatalog r</span>
<span class="s">        ,transient tr</span>
<span class="s">   WHERE tmprc.runcat = one_to_many.old_runcat_id</span>
<span class="s">     AND tmprc.inactive = FALSE</span>
<span class="s">     AND tr.runcat = one_to_many.old_runcat_id</span>
<span class="s">     AND r.xtrsrc = tmprc.xtrsrc</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_delete_1_to_many_inactive_assocskyrgn"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_assocskyrgn">[docs]</a><span class="k">def</span> <span class="nf">_delete_1_to_many_inactive_assocskyrgn</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete the assocskyrgn links of the old runcat</span>

<span class="sd">    Since we replaced this runcat.id with multiple new ones, we now</span>
<span class="sd">    delete the old links.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">DELETE</span>
<span class="s">    FROM assocskyrgn</span>
<span class="s">    WHERE runcat IN (SELECT runcat</span>
<span class="s">                       FROM temprunningcatalog</span>
<span class="s">                       WHERE inactive = FALSE</span>
<span class="s">                       GROUP BY runcat</span>
<span class="s">                       HAVING COUNT(*) &gt; 1</span>
<span class="s">                    )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_delete_1_to_many_inactive_transient"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_transient">[docs]</a><span class="k">def</span> <span class="nf">_delete_1_to_many_inactive_transient</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete the transient sources of the old runcat</span>

<span class="sd">    Since we replaced this runcat.id with multiple new ones, we now</span>
<span class="sd">    delete the old one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">DELETE</span>
<span class="s">    FROM transient</span>
<span class="s">    WHERE runcat IN (SELECT runcat</span>
<span class="s">                       FROM temprunningcatalog</span>
<span class="s">                       WHERE inactive = FALSE</span>
<span class="s">                       GROUP BY runcat</span>
<span class="s">                       HAVING COUNT(*) &gt; 1</span>
<span class="s">                    )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_delete_1_to_many_inactive_assocxtrsource"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_assocxtrsource">[docs]</a><span class="k">def</span> <span class="nf">_delete_1_to_many_inactive_assocxtrsource</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete the association pairs of the old runcat from assocxtrsource</span>

<span class="sd">    NOTE: It might sound confusing, but those are not qualified</span>
<span class="sd">    as inactive in tempruncat (read below).</span>
<span class="sd">    Since we replaced this runcat.id with multiple new one, we first</span>
<span class="sd">    flag it as inactive, after which we delete it from the runningcatalog</span>

<span class="sd">    The subselect selects those valid &quot;old&quot; runcat ids (i.e.,</span>
<span class="sd">    the ones that were not set to inactive for the many-to-many associations).</span>

<span class="sd">    NOTE: We do not have to flag these rows as inactive,</span>
<span class="sd">          no furthr processing depends on these in the assoc run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#NB temprunningcatalog &#39;runcat&#39; field still refers to old,</span>
    <span class="c">#superceded runcat entries.</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">DELETE</span>
<span class="s">    FROM assocxtrsource</span>
<span class="s">    WHERE runcat IN (SELECT runcat</span>
<span class="s">                   FROM temprunningcatalog</span>
<span class="s">                   WHERE inactive = FALSE</span>
<span class="s">                   GROUP BY runcat</span>
<span class="s">                   HAVING COUNT(*) &gt; 1</span>
<span class="s">                )</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_delete_1_to_many_inactive_runcat_flux"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._delete_1_to_many_inactive_runcat_flux">[docs]</a><span class="k">def</span> <span class="nf">_delete_1_to_many_inactive_runcat_flux</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Flag the old runcat ids in the runningcatalog to inactive</span>

<span class="sd">    Since we replaced this runcat.id with multiple new one, we first</span>
<span class="sd">    flag it as inactive, after which we delete it from the runningcatalog</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">DELETE</span>
<span class="s">    FROM runningcatalog_flux</span>
<span class="s">    WHERE runcat IN (SELECT runcat</span>
<span class="s">                   FROM temprunningcatalog</span>
<span class="s">                   WHERE inactive = FALSE</span>
<span class="s">                   GROUP BY runcat</span>
<span class="s">                   HAVING COUNT(*) &gt; 1</span>
<span class="s">                )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_flag_1_to_many_inactive_runcat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._flag_1_to_many_inactive_runcat">[docs]</a><span class="k">def</span> <span class="nf">_flag_1_to_many_inactive_runcat</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Flag the old runcat ids in the runningcatalog to inactive</span>

<span class="sd">    We do not delete them yet, because we still need to clear up all the</span>
<span class="sd">    superseded entries in assocskyrgn, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">UPDATE runningcatalog</span>
<span class="s">   SET inactive = TRUE</span>
<span class="s"> WHERE id IN (SELECT runcat</span>
<span class="s">                FROM temprunningcatalog</span>
<span class="s">               WHERE inactive = FALSE</span>
<span class="s">              GROUP BY runcat</span>
<span class="s">              HAVING COUNT(*) &gt; 1</span>
<span class="s">             )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_flag_1_to_many_inactive_tempruncat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._flag_1_to_many_inactive_tempruncat">[docs]</a><span class="k">def</span> <span class="nf">_flag_1_to_many_inactive_tempruncat</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flag the one-to-many associations from temprunningcatalog.</span>

<span class="sd">    (Since we are done processing them, now.)</span>

<span class="sd">    We do not delete them yet- if we did,</span>
<span class="sd">    we would not be able to cross-match extractedsources to determine</span>
<span class="sd">    which sources did not have a match in temprunningcatalog (&#39;new&#39; sources).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">UPDATE temprunningcatalog</span>
<span class="s">   SET inactive = TRUE</span>
<span class="s"> WHERE runcat IN (SELECT runcat</span>
<span class="s">                    FROM temprunningcatalog</span>
<span class="s">                   WHERE inactive = FALSE</span>
<span class="s">                  GROUP BY runcat</span>
<span class="s">                  HAVING COUNT(*) &gt; 1</span>
<span class="s">                 )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="c"># This is the &quot;master&quot; 1-to-1 association query. We reuse it for associating</span>
<span class="c"># both null detections and monitoring list sources, tweaking the type as</span>
<span class="c"># appropriate.</span></div>
<span class="n">ONE_TO_ONE_ASSOC_QUERY</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocxtrsource</span>
<span class="s">  (runcat</span>
<span class="s">  ,xtrsrc</span>
<span class="s">  ,type</span>
<span class="s">  ,distance_arcsec</span>
<span class="s">  ,r</span>
<span class="s">  ,v_int</span>
<span class="s">  ,eta_int</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  )</span>
<span class="s">  SELECT t0.runcat</span>
<span class="s">        ,t0.xtrsrc</span>
<span class="s">        ,</span><span class="si">%(type)s</span><span class="s"></span>
<span class="s">        ,t0.distance_arcsec</span>
<span class="s">        ,t0.r</span>
<span class="s">        ,t0.v_int_inter / t0.avg_f_int</span>
<span class="s">        ,t0.eta_int_inter / t0.avg_f_int_weight</span>
<span class="s">        ,t0.f_datapoints</span>
<span class="s">    FROM (SELECT tmprc.runcat</span>
<span class="s">                ,tmprc.xtrsrc</span>
<span class="s">                ,tmprc.distance_arcsec</span>
<span class="s">                ,tmprc.r</span>
<span class="s">                ,tmprc.f_datapoints</span>
<span class="s">                ,CASE WHEN tmprc.avg_f_int = 0.0</span>
<span class="s">                      THEN 0.000001</span>
<span class="s">                      ELSE avg_f_int</span>
<span class="s">                 END AS avg_f_int</span>
<span class="s">                ,tmprc.avg_f_int_weight</span>
<span class="s">                ,CASE WHEN tmprc.f_datapoints = 1</span>
<span class="s">                      THEN 0</span>
<span class="s">                      ELSE CASE WHEN ABS(tmprc.avg_f_int_sq - tmprc.avg_f_int * tmprc.avg_f_int) &lt; 8e-14</span>
<span class="s">                                THEN 0</span>
<span class="s">                                ELSE SQRT(CAST(tmprc.f_datapoints AS DOUBLE PRECISION)</span>
<span class="s">                                         * (tmprc.avg_f_int_sq - tmprc.avg_f_int * tmprc.avg_f_int)</span>
<span class="s">                                         / (CAST(tmprc.f_datapoints AS DOUBLE PRECISION) - 1.0)</span>
<span class="s">                                         )</span>
<span class="s">                           END</span>
<span class="s">                 END AS v_int_inter</span>
<span class="s">                ,CASE WHEN tmprc.f_datapoints = 1</span>
<span class="s">                      THEN 0</span>
<span class="s">                      ELSE (CAST(tmprc.f_datapoints AS DOUBLE PRECISION)</span>
<span class="s">                            / (CAST(tmprc.f_datapoints AS DOUBLE PRECISION) - 1.0))</span>
<span class="s">                           * (tmprc.avg_f_int_weight * tmprc.avg_weighted_f_int_sq</span>
<span class="s">                             - tmprc.avg_weighted_f_int * tmprc.avg_weighted_f_int)</span>
<span class="s">                 END AS eta_int_inter</span>
<span class="s">            FROM temprunningcatalog tmprc</span>
<span class="s">           WHERE tmprc.inactive = FALSE</span>
<span class="s">           ) t0</span>
<span class="s">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="_insert_1_to_1_assoc"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_1_assoc">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_1_assoc</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert remaining associations from temprunningcatalog into assocxtrsource.</span>

<span class="sd">    We also calculate the variability indices at the timestamp of the</span>
<span class="sd">    the current image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ONE_TO_ONE_ASSOC_QUERY</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_update_1_to_1_runcat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._update_1_to_1_runcat">[docs]</a><span class="k">def</span> <span class="nf">_update_1_to_1_runcat</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Update the running catalog with the values in temprunningcatalog&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">        UPDATE runningcatalog</span>
<span class="s">           SET datapoints = (SELECT datapoints</span>
<span class="s">                               FROM temprunningcatalog</span>
<span class="s">                              WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                            )</span>
<span class="s">              ,zone = (SELECT zone</span>
<span class="s">                         FROM temprunningcatalog</span>
<span class="s">                        WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                      )</span>
<span class="s">              ,wm_ra = (SELECT wm_ra</span>
<span class="s">                          FROM temprunningcatalog</span>
<span class="s">                         WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                       )</span>
<span class="s">              ,wm_decl = (SELECT wm_decl</span>
<span class="s">                            FROM temprunningcatalog</span>
<span class="s">                           WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                         )</span>
<span class="s">              ,avg_ra_err = (SELECT avg_ra_err</span>
<span class="s">                              FROM temprunningcatalog</span>
<span class="s">                             WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                           )</span>
<span class="s">              ,avg_decl_err = (SELECT avg_decl_err</span>
<span class="s">                                FROM temprunningcatalog</span>
<span class="s">                               WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                             )</span>
<span class="s">              ,wm_uncertainty_ew = (SELECT wm_uncertainty_ew</span>
<span class="s">                                FROM temprunningcatalog</span>
<span class="s">                               WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                             )</span>
<span class="s">              ,wm_uncertainty_ns = (SELECT wm_uncertainty_ns</span>
<span class="s">                                FROM temprunningcatalog</span>
<span class="s">                               WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                             )</span>
<span class="s">              ,avg_wra = (SELECT avg_wra</span>
<span class="s">                            FROM temprunningcatalog</span>
<span class="s">                           WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                         )</span>
<span class="s">              ,avg_wdecl = (SELECT avg_wdecl</span>
<span class="s">                              FROM temprunningcatalog</span>
<span class="s">                             WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                           )</span>
<span class="s">              ,avg_weight_ra = (SELECT avg_weight_ra</span>
<span class="s">                                  FROM temprunningcatalog</span>
<span class="s">                                 WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                               )</span>
<span class="s">              ,avg_weight_decl = (SELECT avg_weight_decl</span>
<span class="s">                                    FROM temprunningcatalog</span>
<span class="s">                                   WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                                 )</span>
<span class="s">              ,x = (SELECT x</span>
<span class="s">                      FROM temprunningcatalog</span>
<span class="s">                     WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                   )</span>
<span class="s">              ,y = (SELECT y</span>
<span class="s">                      FROM temprunningcatalog</span>
<span class="s">                     WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                   )</span>
<span class="s">              ,z = (SELECT z</span>
<span class="s">                      FROM temprunningcatalog</span>
<span class="s">                     WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                   )</span>
<span class="s">         WHERE EXISTS (SELECT runcat</span>
<span class="s">                         FROM temprunningcatalog</span>
<span class="s">                        WHERE temprunningcatalog.runcat = runningcatalog.id</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                      )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="_update_1_to_1_runcat_flux"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._update_1_to_1_runcat_flux">[docs]</a><span class="k">def</span> <span class="nf">_update_1_to_1_runcat_flux</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Updates the fluxes in runningcatalog_flux of an existing band</span>
<span class="sd">    for an existing runcat source.</span>

<span class="sd">    If the runcat, band, stokes entry does exist in runcat_flux,</span>
<span class="sd">    it will be updated with the values from tempruncat.</span>

<span class="sd">    NOTE: It is important to guarantee the sequence:</span>
<span class="sd">          First update the existing entries,</span>
<span class="sd">          then the insert the new entries (next function).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">UPDATE runningcatalog_flux</span>
<span class="s">   SET f_datapoints = (SELECT f_datapoints</span>
<span class="s">                         FROM temprunningcatalog</span>
<span class="s">                        WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                          AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                          AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                      )</span>
<span class="s">      ,avg_f_peak = (SELECT avg_f_peak</span>
<span class="s">                       FROM temprunningcatalog</span>
<span class="s">                      WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                        AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                        AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                        AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                    )</span>
<span class="s">      ,avg_f_peak_sq = (SELECT avg_f_peak_sq</span>
<span class="s">                          FROM temprunningcatalog</span>
<span class="s">                         WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                           AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                           AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                           AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                       )</span>
<span class="s">      ,avg_f_peak_weight = (SELECT avg_f_peak_weight</span>
<span class="s">                              FROM temprunningcatalog</span>
<span class="s">                             WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                               AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                               AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                               AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                           )</span>
<span class="s">      ,avg_weighted_f_peak = (SELECT avg_weighted_f_peak</span>
<span class="s">                                FROM temprunningcatalog</span>
<span class="s">                               WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                                 AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                                 AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                                 AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                             )</span>
<span class="s">      ,avg_weighted_f_peak_sq = (SELECT avg_weighted_f_peak_sq</span>
<span class="s">                                   FROM temprunningcatalog</span>
<span class="s">                                  WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                                    AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                                    AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                                    AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                                )</span>
<span class="s">      ,avg_f_int = (SELECT avg_f_int</span>
<span class="s">                      FROM temprunningcatalog</span>
<span class="s">                     WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                       AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                       AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                       AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                   )</span>
<span class="s">      ,avg_f_int_sq = (SELECT avg_f_int_sq</span>
<span class="s">                         FROM temprunningcatalog</span>
<span class="s">                        WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                          AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                          AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                          AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                      )</span>
<span class="s">      ,avg_f_int_weight = (SELECT avg_f_int_weight</span>
<span class="s">                             FROM temprunningcatalog</span>
<span class="s">                             WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                               AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                               AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                               AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                          )</span>
<span class="s">      ,avg_weighted_f_int = (SELECT avg_weighted_f_int</span>
<span class="s">                               FROM temprunningcatalog</span>
<span class="s">                              WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                                AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                                AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                                AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                            )</span>
<span class="s">      ,avg_weighted_f_int_sq = (SELECT avg_weighted_f_int_sq</span>
<span class="s">                                  FROM temprunningcatalog</span>
<span class="s">                                 WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                                   AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                                   AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                                   AND temprunningcatalog.inactive = FALSE</span>
<span class="s">                               )</span>
<span class="s"> WHERE EXISTS (SELECT runcat</span>
<span class="s">                 FROM temprunningcatalog</span>
<span class="s">                WHERE temprunningcatalog.runcat = runningcatalog_flux.runcat</span>
<span class="s">                  AND temprunningcatalog.band = runningcatalog_flux.band</span>
<span class="s">                  AND temprunningcatalog.stokes = runningcatalog_flux.stokes</span>
<span class="s">                  AND temprunningcatalog.inactive = FALSE</span>
<span class="s">              )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Updated flux for </span><span class="si">%s</span><span class="s"> sources&quot;</span> <span class="o">%</span> <span class="n">cnt</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_1_to_1_runcat_flux"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_1_to_1_runcat_flux">[docs]</a><span class="k">def</span> <span class="nf">_insert_1_to_1_runcat_flux</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Insert the fluxes in runningcatalog_flux of a new band</span>
<span class="sd">    for an existing runcat source.</span>

<span class="sd">    If the runcat, band, stokes entry does not exist (yet) in runcat_flux,</span>
<span class="sd">    we need to insert the new values from tempruncat.</span>
<span class="sd">    This might be the case if a source has been observed at other frequencies,</span>
<span class="sd">    but not in the current band, so there does not exist an entry</span>
<span class="sd">    for this band.</span>

<span class="sd">    NOTE: It is important to guarantee the sequence:</span>
<span class="sd">          First do the update (previous function), then the insert.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO runningcatalog_flux</span>
<span class="s">  (runcat</span>
<span class="s">  ,band</span>
<span class="s">  ,stokes</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  ,avg_f_peak</span>
<span class="s">  ,avg_f_peak_sq</span>
<span class="s">  ,avg_f_peak_weight</span>
<span class="s">  ,avg_weighted_f_peak</span>
<span class="s">  ,avg_weighted_f_peak_sq</span>
<span class="s">  ,avg_f_int</span>
<span class="s">  ,avg_f_int_sq</span>
<span class="s">  ,avg_f_int_weight</span>
<span class="s">  ,avg_weighted_f_int</span>
<span class="s">  ,avg_weighted_f_int_sq</span>
<span class="s">  )</span>
<span class="s">  SELECT runcat</span>
<span class="s">        ,band</span>
<span class="s">        ,stokes</span>
<span class="s">        ,f_datapoints</span>
<span class="s">        ,avg_f_peak</span>
<span class="s">        ,avg_f_peak_sq</span>
<span class="s">        ,avg_f_peak_weight</span>
<span class="s">        ,avg_weighted_f_peak</span>
<span class="s">        ,avg_weighted_f_peak_sq</span>
<span class="s">        ,avg_f_int</span>
<span class="s">        ,avg_f_int_sq</span>
<span class="s">        ,avg_f_int_weight</span>
<span class="s">        ,avg_weighted_f_int</span>
<span class="s">        ,avg_weighted_f_int_sq</span>
<span class="s">    FROM temprunningcatalog</span>
<span class="s">   WHERE inactive = FALSE</span>
<span class="s">     AND NOT EXISTS (SELECT rf.runcat</span>
<span class="s">                       FROM runningcatalog_flux rf</span>
<span class="s">                           ,temprunningcatalog tr</span>
<span class="s">                      WHERE rf.runcat = tr.runcat</span>
<span class="s">                        AND rf.band = tr.band</span>
<span class="s">                        AND rf.stokes = tr.stokes</span>
<span class="s">                        AND tr.inactive = FALSE</span>
<span class="s">                    )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Inserted new fluxes for </span><span class="si">%s</span><span class="s"> sources&quot;</span> <span class="o">%</span> <span class="n">cnt</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_new_runcat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_new_runcat">[docs]</a><span class="k">def</span> <span class="nf">_insert_new_runcat</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert previously unknown sources into the ``runningcatalog`` table.</span>

<span class="sd">    Extractedsources for which no counterpart was found in the</span>
<span class="sd">    runningcatalog (i.e. no pair exists in tempruncat),</span>
<span class="sd">    will be added as a new source to the assocxtrsource,</span>
<span class="sd">    runningcatalog and runningcatalog_flux tables.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># NOTE: Here we select all (inactive TRUE&amp;FALSE) tempruncat entries</span>
    <span class="c"># source in order to exclude all extractedsources that have been associated.</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO runningcatalog</span>
<span class="s">  (xtrsrc</span>
<span class="s">  ,dataset</span>
<span class="s">  ,datapoints</span>
<span class="s">  ,zone</span>
<span class="s">  ,wm_ra</span>
<span class="s">  ,wm_decl</span>
<span class="s">  ,avg_ra_err</span>
<span class="s">  ,avg_decl_err</span>
<span class="s">  ,wm_uncertainty_ew</span>
<span class="s">  ,wm_uncertainty_ns</span>
<span class="s">  ,avg_wra</span>
<span class="s">  ,avg_wdecl</span>
<span class="s">  ,avg_weight_ra</span>
<span class="s">  ,avg_weight_decl</span>
<span class="s">  ,x</span>
<span class="s">  ,y</span>
<span class="s">  ,z</span>
<span class="s">  )</span>
<span class="s">  SELECT new_src.xtrsrc</span>
<span class="s">        ,new_src.dataset</span>
<span class="s">        ,new_src.datapoints</span>
<span class="s">        ,new_src.zone</span>
<span class="s">        ,new_src.wm_ra</span>
<span class="s">        ,new_src.wm_decl</span>
<span class="s">        ,new_src.avg_ra_err</span>
<span class="s">        ,new_src.avg_decl_err</span>
<span class="s">        ,new_src.wm_uncertainty_ew</span>
<span class="s">        ,new_src.wm_uncertainty_ns</span>
<span class="s">        ,new_src.avg_wra</span>
<span class="s">        ,new_src.avg_wdecl</span>
<span class="s">        ,new_src.avg_weight_ra</span>
<span class="s">        ,new_src.avg_weight_decl</span>
<span class="s">        ,new_src.x</span>
<span class="s">        ,new_src.y</span>
<span class="s">        ,new_src.z</span>
<span class="s">    FROM (SELECT x0.id AS xtrsrc</span>
<span class="s">                ,i0.dataset</span>
<span class="s">                ,1 AS datapoints</span>
<span class="s">                ,x0.zone</span>
<span class="s">                ,x0.ra AS wm_ra</span>
<span class="s">                ,x0.decl AS wm_decl</span>
<span class="s">                ,x0.ra_err AS avg_ra_err</span>
<span class="s">                ,x0.decl_err AS avg_decl_err</span>
<span class="s">                ,x0.uncertainty_ew AS wm_uncertainty_ew</span>
<span class="s">                ,x0.uncertainty_ns AS wm_uncertainty_ns</span>
<span class="s">                ,x0.ra / (x0.uncertainty_ew * x0.uncertainty_ew) AS avg_wra</span>
<span class="s">                ,x0.decl / (x0.uncertainty_ns * x0.uncertainty_ns) AS avg_wdecl</span>
<span class="s">                ,1 / (x0.uncertainty_ew * x0.uncertainty_ew) AS avg_weight_ra</span>
<span class="s">                ,1 / (x0.uncertainty_ns * x0.uncertainty_ns) AS avg_weight_decl</span>
<span class="s">                ,x0.x</span>
<span class="s">                ,x0.y</span>
<span class="s">                ,x0.z</span>
<span class="s">            FROM extractedsource x0</span>
<span class="s">                ,image i0</span>
<span class="s">           WHERE x0.image = i0.id</span>
<span class="s">             AND x0.image = </span><span class="si">%s</span><span class="s"></span>
<span class="s">         ) new_src</span>
<span class="s">         LEFT OUTER JOIN temprunningcatalog tmprc</span>
<span class="s">         ON new_src.xtrsrc = tmprc.xtrsrc</span>
<span class="s">   WHERE tmprc.xtrsrc IS NULL</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">image_id</span><span class="p">,),</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="k">if</span> <span class="n">ins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Added </span><span class="si">%s</span><span class="s"> new sources to runningcatalog&quot;</span> <span class="o">%</span> <span class="n">ins</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="_insert_new_runcat_flux"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_new_runcat_flux">[docs]</a><span class="k">def</span> <span class="nf">_insert_new_runcat_flux</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Insert previously unknown sources into the ``runningcatalog_flux`` table.</span>

<span class="sd">    Extractedsources for which not a counterpart was found in the</span>
<span class="sd">    runningcatalog, will be added as a new source to the assocxtrsource,</span>
<span class="sd">    runningcatalog and runningcatalog_flux tables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO runningcatalog_flux</span>
<span class="s">  (runcat</span>
<span class="s">  ,band</span>
<span class="s">  ,stokes</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  ,avg_f_peak</span>
<span class="s">  ,avg_f_peak_sq</span>
<span class="s">  ,avg_f_peak_weight</span>
<span class="s">  ,avg_weighted_f_peak</span>
<span class="s">  ,avg_weighted_f_peak_sq</span>
<span class="s">  ,avg_f_int</span>
<span class="s">  ,avg_f_int_sq</span>
<span class="s">  ,avg_f_int_weight</span>
<span class="s">  ,avg_weighted_f_int</span>
<span class="s">  ,avg_weighted_f_int_sq</span>
<span class="s">  )</span>
<span class="s">  SELECT r0.id</span>
<span class="s">        ,i0.band</span>
<span class="s">        ,i0.stokes</span>
<span class="s">        ,1 AS f_datapoints</span>
<span class="s">        ,x0.f_peak</span>
<span class="s">        ,x0.f_peak * x0.f_peak</span>
<span class="s">        ,1 / (x0.f_peak_err * x0.f_peak_err)</span>
<span class="s">        ,x0.f_peak / (x0.f_peak_err * x0.f_peak_err)</span>
<span class="s">        ,x0.f_peak * x0.f_peak / (x0.f_peak_err * x0.f_peak_err)</span>
<span class="s">        ,x0.f_int</span>
<span class="s">        ,x0.f_int * x0.f_int</span>
<span class="s">        ,1 / (x0.f_int_err * x0.f_int_err)</span>
<span class="s">        ,x0.f_int / (x0.f_int_err * x0.f_int_err)</span>
<span class="s">        ,x0.f_int * x0.f_int / (x0.f_int_err * x0.f_int_err)</span>
<span class="s">    FROM image i0</span>
<span class="s">        ,(SELECT x1.id AS xtrsrc</span>
<span class="s">            FROM extractedsource x1</span>
<span class="s">                 LEFT OUTER JOIN temprunningcatalog tmprc</span>
<span class="s">                 ON x1.id = tmprc.xtrsrc</span>
<span class="s">            WHERE x1.image = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">              AND tmprc.xtrsrc IS NULL</span>
<span class="s">          ) new_src</span>
<span class="s">        ,runningcatalog r0</span>
<span class="s">        ,extractedsource x0</span>
<span class="s">   WHERE i0.id = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">     AND r0.xtrsrc = new_src.xtrsrc</span>
<span class="s">     AND x0.id = r0.xtrsrc</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">},</span> <span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_new_runcat_skyrgn_assocs"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_new_runcat_skyrgn_assocs">[docs]</a><span class="k">def</span> <span class="nf">_insert_new_runcat_skyrgn_assocs</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process newly created entries from the runningcatalog,</span>
<span class="sd">    determine which skyregions they lie within.</span>

<span class="sd">    Upon creation of a new runningcatalog entry,</span>
<span class="sd">    we need to determine which previous fields of view (skyrgns)</span>
<span class="sd">    we expect to see it in.</span>
<span class="sd">    This knowledge helps us to make accurate guesses as whether a new</span>
<span class="sd">    source is really transient or simply being surveyed for the first time.</span>

<span class="sd">    .. note:</span>

<span class="sd">        This could be made more efficient, at the cost of added complexity,</span>
<span class="sd">        by tracking which skyregions overlap,</span>
<span class="sd">        and then only testing for membership of overlapping regions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># First, mark membership in the skyregion of the image of initial detection.</span>
    <span class="c"># We look for extracted sources from this image</span>
    <span class="c"># that are not in temprunningcatalog, i.e. have no association candidates.</span>

    <span class="c"># By dealing with these separately, we save a number of radius comparison</span>
    <span class="c"># operations proportional to the number of new sources in this field.</span>
    <span class="n">assocskyrgn_parent_qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocskyrgn</span>
<span class="s">    (runcat</span>
<span class="s">    ,skyrgn</span>
<span class="s">    )</span>
<span class="s">SELECT t0.runcat</span>
<span class="s">      ,t0.skyrgn</span>
<span class="s">  FROM (SELECT ex.id AS xtrsrc</span>
<span class="s">              ,rc.id as runcat</span>
<span class="s">              ,im.skyrgn</span>
<span class="s">          FROM extractedsource ex</span>
<span class="s">              ,runningcatalog rc</span>
<span class="s">              ,image im</span>
<span class="s">         WHERE ex.image = </span><span class="si">%(img_id)s</span><span class="s"></span>
<span class="s">           AND rc.xtrsrc = ex.id</span>
<span class="s">           AND ex.image = im.id</span>
<span class="s">       ) t0</span>
<span class="s">       LEFT OUTER JOIN temprunningcatalog tmprc</span>
<span class="s">       ON t0.xtrsrc = tmprc.xtrsrc</span>
<span class="s">WHERE tmprc.xtrsrc IS NULL</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">assocskyrgn_parent_qry</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;img_id&#39;</span><span class="p">:</span><span class="n">image_id</span><span class="p">},</span> <span class="bp">True</span><span class="p">)</span>

    <span class="c">#Now search all the other skyregions *in same dataset* to determine matches:</span>
    <span class="n">assocskyrgn_others_qry</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocskyrgn</span>
<span class="s">    (runcat</span>
<span class="s">    ,skyrgn</span>
<span class="s">    ,distance_deg</span>
<span class="s">    )</span>
<span class="s">SELECT new_src.runcat as runcatid</span>
<span class="s">      ,sky.id as skyrgnid</span>
<span class="s">      ,DEGREES(2 * ASIN(SQRT( (rc1.x - sky.x) * (rc1.x - sky.x)</span>
<span class="s">                         + (rc1.y - sky.y) * (rc1.y - sky.y)</span>
<span class="s">                         + (rc1.z - sky.z) * (rc1.z - sky.z)</span>
<span class="s">                         ) / 2)</span>
<span class="s">           ) AS idistance_deg</span>
<span class="s">  FROM skyregion sky</span>
<span class="s">       ,runningcatalog rc1</span>
<span class="s">      ,(SELECT t0.runcat</span>
<span class="s">              ,t0.self_skyrgn</span>
<span class="s">          FROM (SELECT ex.id AS xtrsrc</span>
<span class="s">                      ,rc0.id as runcat</span>
<span class="s">                      ,im.skyrgn as self_skyrgn</span>
<span class="s">                  FROM extractedsource ex</span>
<span class="s">                      ,runningcatalog rc0</span>
<span class="s">                      ,image im</span>
<span class="s">                 WHERE ex.image = </span><span class="si">%(img_id)s</span><span class="s"></span>
<span class="s">                   AND rc0.xtrsrc = ex.id</span>
<span class="s">                   AND ex.image = im.id</span>
<span class="s">               ) t0</span>
<span class="s">               LEFT OUTER JOIN temprunningcatalog tmprc</span>
<span class="s">               ON t0.xtrsrc = tmprc.xtrsrc</span>
<span class="s">        WHERE tmprc.xtrsrc IS NULL</span>
<span class="s">        ) new_src</span>
<span class="s">    WHERE rc1.id = new_src.runcat</span>
<span class="s">      AND sky.dataset = rc1.dataset</span>
<span class="s">      AND sky.id &lt;&gt; new_src.self_skyrgn</span>
<span class="s">      AND  DEGREES(2 * ASIN(SQRT( (rc1.x - sky.x) * (rc1.x - sky.x)</span>
<span class="s">                                     + (rc1.y - sky.y) * (rc1.y - sky.y)</span>
<span class="s">                                     + (rc1.z - sky.z) * (rc1.z - sky.z)</span>
<span class="s">                                    ) / 2)</span>
<span class="s">               ) &lt; sky.xtr_radius</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">assocskyrgn_others_qry</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;img_id&#39;</span><span class="p">:</span><span class="n">image_id</span><span class="p">},</span> <span class="bp">True</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="_insert_new_assocxtrsource"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._insert_new_assocxtrsource">[docs]</a><span class="k">def</span> <span class="nf">_insert_new_assocxtrsource</span><span class="p">(</span><span class="n">image_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert new associations for previously unknown sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO assocxtrsource</span>
<span class="s">  (runcat</span>
<span class="s">  ,xtrsrc</span>
<span class="s">  ,type</span>
<span class="s">  ,distance_arcsec</span>
<span class="s">  ,r</span>
<span class="s">  ,v_int</span>
<span class="s">  ,eta_int</span>
<span class="s">  ,f_datapoints</span>
<span class="s">  )</span>
<span class="s">  SELECT r0.id AS runcat</span>
<span class="s">        ,r0.xtrsrc</span>
<span class="s">        ,4</span>
<span class="s">        ,0</span>
<span class="s">        ,0</span>
<span class="s">        ,0</span>
<span class="s">        ,0</span>
<span class="s">        ,1</span>
<span class="s">    FROM (SELECT x1.id AS xtrsrc</span>
<span class="s">            FROM extractedsource x1</span>
<span class="s">                 LEFT OUTER JOIN temprunningcatalog tmprc</span>
<span class="s">                 ON x1.id = tmprc.xtrsrc</span>
<span class="s">            WHERE x1.image = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">              AND tmprc.xtrsrc IS NULL</span>
<span class="s">          ) new_src</span>
<span class="s">        ,runningcatalog r0</span>
<span class="s">   WHERE r0.xtrsrc = new_src.xtrsrc</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;image_id&#39;</span><span class="p">:</span><span class="n">image_id</span><span class="p">},</span> <span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="_determine_newsource_previous_limits"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._determine_newsource_previous_limits">[docs]</a><span class="k">def</span> <span class="nf">_determine_newsource_previous_limits</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">new_source_sigma_margin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines which new-runcat sources are also probably transient.</span>

<span class="sd">    Looks up previous images relevant to this source-position, using the</span>
<span class="sd">    following criteria - images must:</span>

<span class="sd">     - overlap the new-source position, according to the skyregion</span>
<span class="sd">       information;</span>
<span class="sd">     - be in the same dataset;</span>
<span class="sd">     - be in the same frequency band;</span>
<span class="sd">     - have an earlier timestamp than the current image;</span>
<span class="sd">     - have not been rejected.</span>

<span class="sd">    For those images we calculate the per-previous-image detection-thresholds,</span>
<span class="sd">    which are defined as follows.</span>

<span class="sd">    A new source is &#39;possibly transient&#39; (type 0) if it</span>
<span class="sd">    passes the following tests:</span>

<span class="sd">     - Was not detected in a skyregion being surveyed for the first time.</span>
<span class="sd">     - Has a flux-value such that:</span>

<span class="sd">        flux &gt; MIN_OVER_I [ (rms_min_I*(det_I + new_source_sigma_margin) ]</span>

<span class="sd">      (where I indexes the images)</span>
<span class="sd">      i.e. if it was a steady-source, it should have been already detected if</span>
<span class="sd">      it was in the *low-RMS* area of the previous image with best detection</span>
<span class="sd">      threshold, even allowing for noise fluctuations.</span>

<span class="sd">    Furthermore, a new source is &#39;likely transient&#39; (type 1) if it is additionally</span>
<span class="sd">    bright enough that, if it were a steady source, it should have been detected</span>
<span class="sd">    even if it was in the *high-RMS* area of the aforementioned &#39;low rms_min&#39;</span>
<span class="sd">    image, i.e.</span>

<span class="sd">        flux &gt; (rms_max_I*(det_I + new_source_sigma_margin))</span>

<span class="sd">    Note that, once we have located the image with best &#39;low rms threshold&#39;,</span>
<span class="sd">    we then use that image to *also* generate the &#39;high rms threshold&#39;.</span>
<span class="sd">    Strictly speaking, this is non-optimal - we should run a fresh search</span>
<span class="sd">    against all images to find the best &#39;high rms threshold&#39;. However, I&#39;m</span>
<span class="sd">    working on the assumption that most of</span>
<span class="sd">    the time the image with best low-threshold will also have best</span>
<span class="sd">    high-threshold, and even when that is not the case we won&#39;t lose too much</span>
<span class="sd">    accuracy. The benefits of this assumption are simplicity, and possibly</span>
<span class="sd">    faster performance, but this might need to be re-examined in future,</span>
<span class="sd">    especially if we start ingesting images of wildly differing sizes and</span>
<span class="sd">    noise non-uniformity characteristics (e.g. single pointings vs mosaics) etc.</span>

<span class="sd">    We use peak flux (f_peak) as the flux value here, since that is likely</span>
<span class="sd">    to be the deciding factor in whether a source gets blindly extracted or not.</span>
<span class="sd">    (NB This is a hunch, rigorous investigation welcome.)</span>

<span class="sd">    We set the siglevel to 1 and the variability indices 0 for</span>
<span class="sd">    new transients.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># This is another hairy query, but it breaks down like so:</span>
    <span class="c">#</span>
    <span class="c"># The innermost SELECT (unassoc_xtr) is a standard query</span>
    <span class="c"># that we use to grab extractedsources from the current image that</span>
    <span class="c"># do not have a candidate  runcat counterpart from previous images.</span>
    <span class="c"># Note that, by the time this query is run, a new runningcatalog entry has</span>
    <span class="c"># been inserted for them, and the skyregion matching has been done.</span>
    <span class="c">#</span>
    <span class="c"># Next, we match those new sources with previous images overlapping</span>
    <span class="c"># their position according to the criteria in the docstring above,</span>
    <span class="c"># and calculate detection thresholds for each of those images.</span>
    <span class="c">#</span>
    <span class="c"># We then thinly wrap the resulting &#39;matched_imgs&#39; set in a query</span>
    <span class="c"># to sort them by low_flux_threshold, with high_flux_threshold as the</span>
    <span class="c"># secondary criteria in case of a tie (&#39;ordered_matched_imgs&#39;).</span>
    <span class="c">#</span>
    <span class="c"># Finally, we pull out the results we want - new source flux above the low</span>
    <span class="c"># threshold, image ID of the &#39;best&#39; previous image according to the sorting,</span>
    <span class="c"># and run a final CASE to determine if the new source also passes the</span>
    <span class="c"># high flux threshold.</span>
    <span class="c">#</span>


    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">INSERT INTO transient</span>
<span class="s">  (runcat</span>
<span class="s">  ,band</span>
<span class="s">  ,siglevel</span>
<span class="s">  ,V_int</span>
<span class="s">  ,eta_int</span>
<span class="s">  ,trigger_xtrsrc</span>
<span class="s">  ,transient_type</span>
<span class="s">  ,previous_limits_image</span>
<span class="s">  )</span>
<span class="s">  SELECT new_src_runcat_id AS runcat</span>
<span class="s">         ,band AS band</span>
<span class="s">         ,1 AS siglevel</span>
<span class="s">         ,0 AS v_int</span>
<span class="s">         ,0 AS eta_int</span>
<span class="s">         ,new_src_xtr_id AS trigger_xtrsrc</span>
<span class="s">         ,CASE WHEN new_src_flux &gt; high_flux_threshold</span>
<span class="s">               THEN 1</span>
<span class="s">               ELSE 0</span>
<span class="s">          END as transient_type</span>
<span class="s">         ,prev_img_id AS previous_limits_image</span>
<span class="s">  FROM ( SELECT  new_src_runcat_id</span>
<span class="s">                ,new_src_xtr_id</span>
<span class="s">                ,new_src_flux</span>
<span class="s">                ,band</span>
<span class="s">                ,prev_img_id</span>
<span class="s">                ,low_flux_threshold</span>
<span class="s">                ,high_flux_threshold</span>
<span class="s">                ,ROW_NUMBER() OVER (</span>
<span class="s">                         PARTITION BY new_src_xtr_id</span>
<span class="s">                         ORDER BY low_flux_threshold ASC,</span>
<span class="s">                                  high_flux_threshold ASC</span>
<span class="s">                         ) AS row_num</span>
<span class="s">         FROM ( SELECT runcat1.id as new_src_runcat_id</span>
<span class="s">                      ,unassoc_xtr.xtrsrc_id as new_src_xtr_id</span>
<span class="s">                      ,unassoc_xtr.f_peak as new_src_flux</span>
<span class="s">                      ,this_img.band</span>
<span class="s">                      ,prev_imgs.id as prev_img_id</span>
<span class="s">                      ,(prev_imgs.rms_min *</span>
<span class="s">                            (prev_imgs.detection_thresh + </span><span class="si">%(sigma_margin)s</span><span class="s">))</span>
<span class="s">                        AS low_flux_threshold</span>
<span class="s">                      ,(prev_imgs.rms_max *</span>
<span class="s">                            (prev_imgs.detection_thresh + </span><span class="si">%(sigma_margin)s</span><span class="s">))</span>
<span class="s">                        AS high_flux_threshold</span>
<span class="s">                FROM (SELECT x1.id AS xtrsrc_id</span>
<span class="s">                          ,x1.f_peak</span>
<span class="s">                      FROM extractedsource x1</span>
<span class="s">                      WHERE x1.image = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">                      AND x1.id NOT IN (SELECT xtrsrc FROM temprunningcatalog)</span>
<span class="s">                    ) unassoc_xtr</span>
<span class="s">                   ,runningcatalog runcat1</span>
<span class="s">                   ,assocskyrgn asky1</span>
<span class="s">                   ,image this_img</span>
<span class="s">                   ,image prev_imgs</span>
<span class="s">                WHERE this_img.id = </span><span class="si">%(image_id)s</span><span class="s"></span>
<span class="s">                AND runcat1.xtrsrc = unassoc_xtr.xtrsrc_id</span>
<span class="s">                AND asky1.runcat = runcat1.id</span>
<span class="s">                AND prev_imgs.dataset = this_img.dataset</span>
<span class="s">                AND prev_imgs.skyrgn = asky1.skyrgn</span>
<span class="s">                AND prev_imgs.band = this_img.band</span>
<span class="s">                AND this_img.taustart_ts &gt; prev_imgs.taustart_ts</span>
<span class="s">                AND prev_imgs.id NOT IN (select image from rejection)</span>
<span class="s">         ) matched_imgs</span>
<span class="s">  ) ordered_matched_imgs</span>
<span class="s">  WHERE row_num = 1</span>
<span class="s">    AND new_src_flux &gt; low_flux_threshold</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;image_id&#39;</span><span class="p">:</span> <span class="n">image_id</span><span class="p">,</span>
              <span class="s">&#39;sigma_margin&#39;</span><span class="p">:</span> <span class="n">new_source_sigma_margin</span><span class="p">}</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="k">if</span> <span class="n">ins</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Added </span><span class="si">%s</span><span class="s"> new sources to transient table&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ins</span><span class="p">,))</span>

</div>
<div class="viewcode-block" id="_update_ff_runcat_extractedsource"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._update_ff_runcat_extractedsource">[docs]</a><span class="k">def</span> <span class="nf">_update_ff_runcat_extractedsource</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    We are about to delete the runcats that are inactivated, and</span>
<span class="sd">    therefore have to set the ff_runcat reference in extractedsource to NULL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">UPDATE extractedsource</span>
<span class="s">   SET ff_runcat = NULL</span>
<span class="s"> WHERE EXISTS (SELECT id</span>
<span class="s">                 FROM runningcatalog</span>
<span class="s">                WHERE runningcatalog.id = extractedsource.ff_runcat</span>
<span class="s">                  AND runningcatalog.inactive = TRUE</span>
<span class="s">              )</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>
    <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Unset ff_runcat for </span><span class="si">%s</span><span class="s"> extractedsources&quot;</span> <span class="o">%</span> <span class="n">cnt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="_delete_inactive_runcat"><a class="viewcode-back" href="../../../devref/tkp/database/association.html#tkp.db.associations._delete_inactive_runcat">[docs]</a><span class="k">def</span> <span class="nf">_delete_inactive_runcat</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Delete the one-to-many associations from temprunningcatalog,</span>
<span class="sd">    and delete the inactive rows from runningcatalog.</span>

<span class="sd">    After the one-to-many associations have been processed,</span>
<span class="sd">    they can be deleted from the temporary table and</span>
<span class="sd">    the runningcatalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">DELETE</span>
<span class="s">  FROM runningcatalog</span>
<span class="s"> WHERE inactive = TRUE</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">tkp</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/lofar.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">LOFAR Transients Pipeline 2.0-pre documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 20112014, LOFAR Transients Key Science Project.
    </div>
  </body>
</html>