<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tkp.sourcefinder.extract &mdash; LOFAR Transients Pipeline 2.0-pre documentation</title>
    
    <link rel="stylesheet" href="../../../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.0-pre',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/lofar.ico"/>
    <link rel="top" title="LOFAR Transients Pipeline 2.0-pre documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">LOFAR Transients Pipeline 2.0-pre documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tkp.sourcefinder.extract</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Source Extraction Helpers.</span>

<span class="sd">These are used in conjunction with image.ImageData.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="c"># DictMixin may need to be replaced using collections.MutableMapping;</span>
<span class="c"># see http://docs.python.org/library/userdict.html#UserDict.DictMixin</span>
<span class="kn">from</span> <span class="nn">UserDict</span> <span class="kn">import</span> <span class="n">DictMixin</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ndimage</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">tkp.sourcefinder.deconv</span> <span class="kn">import</span> <span class="n">deconv</span>
<span class="kn">from</span> <span class="nn">..utility</span> <span class="kn">import</span> <span class="n">coordinates</span>
<span class="kn">from</span> <span class="nn">..utility.uncertain</span> <span class="kn">import</span> <span class="n">Uncertain</span>
<span class="kn">from</span> <span class="nn">.gaussian</span> <span class="kn">import</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c"># This is used as a dummy value, -BIGNUM values will be always be masked.</span>
<span class="c"># As such, it should be larger than the expected range of real values,</span>
<span class="c"># since we will get negative values representing real data after</span>
<span class="c"># background subtraction, etc.</span>
<span class="n">BIGNUM</span> <span class="o">=</span> <span class="mf">99999.0</span>

<div class="viewcode-block" id="Island"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Island">[docs]</a><span class="k">class</span> <span class="nc">Island</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The source extraction process forms islands, which it then fits.</span>
<span class="sd">    Each island needs to know its position in the image (ie, x, y pixel</span>
<span class="sd">    value at one corner), the threshold above which it is detected</span>
<span class="sd">    (analysis_threshold by default, but will increase if the island is</span>
<span class="sd">    the result of deblending), and a data array.</span>

<span class="sd">    The island should provide a means of deblending: splitting itself</span>
<span class="sd">    apart and returning multiple sub-islands, if necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">analysis_threshold</span><span class="p">,</span> <span class="n">detection_map</span><span class="p">,</span>
        <span class="n">beam</span><span class="p">,</span> <span class="n">deblend_nthresh</span><span class="p">,</span> <span class="n">deblend_mincont</span><span class="p">,</span> <span class="n">structuring_element</span><span class="p">,</span>
        <span class="n">rms_orig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flux_orig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">subthrrange</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>

        <span class="c"># deblend_nthresh is the number of subthresholds used when deblending.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span> <span class="o">=</span> <span class="n">deblend_nthresh</span>
        <span class="c"># If we deblend too far, we hit the recursion limit. And it&#39;s slow.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Limiting to 300 deblending subtresholds&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Using </span><span class="si">%d</span><span class="s"> subthresholds&quot;</span><span class="p">,</span> <span class="n">deblend_nthresh</span><span class="p">)</span>

        <span class="c"># Deblended components of this island must contain at least</span>
        <span class="c"># deblend_mincont times the total flux of the original to be regarded</span>
        <span class="c"># as significant.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deblend_mincont</span> <span class="o">=</span> <span class="n">deblend_mincont</span>

        <span class="c"># The structuring element defines connectivity between pixels.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structuring_element</span> <span class="o">=</span> <span class="n">structuring_element</span>

        <span class="c"># NB we have set all unused data to -(lots) before passing it to</span>
        <span class="c"># Island().</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">BIGNUM</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rms</span> <span class="o">=</span> <span class="n">rms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_threshold</span> <span class="o">=</span> <span class="n">analysis_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_map</span> <span class="o">=</span> <span class="n">detection_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="n">beam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pos</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">maximum_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rms_orig</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rms_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rms_orig</span> <span class="o">=</span> <span class="n">rms_orig</span>
        <span class="c"># The idea here is to retain the flux of the original, unblended</span>
        <span class="c"># island. That flux is used as a criterion for deblending.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flux_orig</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_orig</span> <span class="o">=</span> <span class="n">flux_orig</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subthrrange</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subthrrange</span> <span class="o">=</span> <span class="n">subthrrange</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subthrrange</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">generate_subthresholds</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Island.deblend"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Island.deblend">[docs]</a>    <span class="k">def</span> <span class="nf">deblend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a decomposed numpy array of all the subislands.</span>

<span class="sd">        Iterate up through subthresholds, looking for our island</span>
<span class="sd">        splitting into two. If it does, start again, with two or more</span>
<span class="sd">        separate islands.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Deblending source&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subthrrange</span><span class="p">[</span><span class="n">niter</span><span class="p">:]:</span>

            <span class="c"># The idea is to retain the parent island when no significant</span>
            <span class="c"># subislands are found and jump to the next subthreshold</span>
            <span class="c"># using niter.</span>
            <span class="c"># Deblending is started at a level higher than the lowest</span>
            <span class="c"># pixel value in the island.</span>
            <span class="c"># Deblending at the level of the lowest pixel value will</span>
            <span class="c"># likely not yield anything, because the island was formed at</span>
            <span class="c"># threshold just below that.</span>
            <span class="c"># So that is why we use niter+1 (&gt;=1) instead of niter (&gt;=0).</span>

            <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
                <span class="c"># level is above the highest pixel value...</span>
                <span class="c"># Return the current island.</span>
                <span class="k">break</span>
            <span class="n">clipped_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">level</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">labels</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">((</span><span class="n">clipped_data</span><span class="p">),</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">structuring_element</span><span class="p">)</span>
            <span class="c"># If we have more than one island, then we need to make subislands.</span>
            <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">subislands</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                    <span class="n">label</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">newdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=-</span><span class="n">BIGNUM</span><span class="p">),</span> <span class="o">-</span><span class="n">BIGNUM</span>
                    <span class="p">)</span>
                    <span class="c"># NB: In class Island(object), rms * analysis_threshold</span>
                    <span class="c"># is taken as the threshold for the bottom of the island.</span>
                    <span class="c"># Everything below that level is masked.</span>
                    <span class="c"># For subislands, this product should be equal to level</span>
                    <span class="c"># and flat, i.e., horizontal.</span>
                    <span class="c"># We can achieve this by setting rms=level*ones and</span>
                    <span class="c"># analysis_threshold=1.</span>
                    <span class="n">island</span> <span class="o">=</span> <span class="n">Island</span><span class="p">(</span>
                                 <span class="n">newdata</span><span class="p">[</span><span class="n">chunk</span><span class="p">],</span>
                                 <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">chunk</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">level</span><span class="p">),</span>
                                 <span class="p">(</span>
                                     <span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span>
                                     <span class="nb">slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
                                 <span class="p">),</span>
                                 <span class="mi">1</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">detection_map</span><span class="p">[</span><span class="n">chunk</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">deblend_mincont</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">structuring_element</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">rms_orig</span><span class="p">[</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">flux_orig</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">subthrrange</span>
                            <span class="p">)</span>

                    <span class="n">subislands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">island</span><span class="p">)</span>
                <span class="c"># This line should filter out any subisland with insufficient</span>
                <span class="c"># flux, in about the same way as SExtractor.</span>
                <span class="c"># Sufficient means: the flux of the branch above the</span>
                <span class="c"># subthreshold (=level) must exceed some user given fraction</span>
                <span class="c"># of the composite object, i.e., the original island.</span>
                <span class="n">subislands</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">isl</span><span class="p">:</span> <span class="p">(</span><span class="n">isl</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">isl</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">level</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">isl</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deblend_mincont</span> <span class="o">*</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">flux_orig</span><span class="p">,</span> <span class="n">subislands</span><span class="p">)</span>
                <span class="c"># Discard subislands below detection threshold</span>
                <span class="n">subislands</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">isl</span><span class="p">:</span> <span class="p">(</span><span class="n">isl</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">isl</span><span class="o">.</span><span class="n">detection_map</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">subislands</span><span class="p">)</span>
                <span class="n">numbersignifsub</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subislands</span><span class="p">)</span>
                <span class="c"># Proceed with the previous island, but make sure the next</span>
                <span class="c"># subthreshold is higher than the present one.</span>
                <span class="c"># Or we would end up in an infinite loop...</span>
                <span class="k">if</span> <span class="n">numbersignifsub</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">niter</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span><span class="p">:</span>
                        <span class="c"># Apparently, the map command always results in</span>
                        <span class="c"># nested lists.</span>
                        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
                            <span class="k">lambda</span> <span class="n">island</span><span class="p">:</span> <span class="n">island</span><span class="o">.</span><span class="n">deblend</span><span class="p">(</span><span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">subislands</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">subislands</span>
                <span class="k">elif</span> <span class="n">numbersignifsub</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">niter</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">deblend_nthresh</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">Island</span><span class="o">.</span><span class="n">deblend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="n">niter</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># In this case we have numbersignifsub == 0 or</span>
                    <span class="c"># (1 and reached the highest subthreshold level).</span>
                    <span class="c"># Pull out of deblending loop, return current island.</span>
                    <span class="k">break</span>
        <span class="c"># We&#39;ve not found any subislands: just return this island.</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Island.threshold"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Island.threshold">[docs]</a>    <span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Threshold&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_threshold</span>
</div>
<div class="viewcode-block" id="Island.noise"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Island.noise">[docs]</a>    <span class="k">def</span> <span class="nf">noise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Noise at maximum position&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pos</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Island.sig"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Island.sig">[docs]</a>    <span class="k">def</span> <span class="nf">sig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deviation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_orig</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Island.fit"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Island.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit the position&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">measurement</span><span class="p">,</span> <span class="n">gauss_residual</span> <span class="o">=</span> <span class="n">source_profile_and_errors</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># Fitting failed</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Moments &amp; Gaussian fitting failed at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">measurement</span><span class="p">[</span><span class="s">&quot;xbar&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">measurement</span><span class="p">[</span><span class="s">&quot;ybar&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">measurement</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">measurement</span><span class="p">,</span> <span class="n">gauss_residual</span>

</div></div>
<div class="viewcode-block" id="ParamSet"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.ParamSet">[docs]</a><span class="k">class</span> <span class="nc">ParamSet</span><span class="p">(</span><span class="n">DictMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All the source fitting methods should go to produce a ParamSet, which</span>
<span class="sd">    gives all the information necessary to make a Detection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean_bias</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">clean_bias_error</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">frac_flux_cal_error</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">alpha_maj1</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">alpha_min1</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                 <span class="n">alpha_maj2</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha_min2</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">alpha_maj3</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">alpha_min3</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_bias</span> <span class="o">=</span> <span class="n">clean_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clean_bias_error</span> <span class="o">=</span> <span class="n">clean_bias_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frac_flux_cal_error</span> <span class="o">=</span> <span class="n">frac_flux_cal_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_maj1</span> <span class="o">=</span> <span class="n">alpha_maj1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_min1</span> <span class="o">=</span> <span class="n">alpha_min1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_maj2</span> <span class="o">=</span> <span class="n">alpha_maj2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_min2</span> <span class="o">=</span> <span class="n">alpha_min2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_maj3</span> <span class="o">=</span> <span class="n">alpha_maj3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_min3</span> <span class="o">=</span> <span class="n">alpha_min3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;peak&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;flux&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;xbar&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;ybar&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;semimajor&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;semiminor&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;theta&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;semimaj_deconv&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;semimin_deconv&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">(),</span>
            <span class="s">&#39;theta_deconv&#39;</span><span class="p">:</span> <span class="n">Uncertain</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="c"># This parameter gives the number of components that could not be</span>
        <span class="c"># deconvolved, IERR from deconf.f.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deconv_imposs</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c"># These flags are used to indicate where the values stored in this</span>
        <span class="c"># parameterset have come from: we set them to True if &amp; when moments</span>
        <span class="c"># and/or Gaussian fitting succeeds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moments</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Uncertain</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="n">item</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;err&#39;</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="ow">in</span>  <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;Invalid parameter&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ParamSet.keys"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.ParamSet.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ParamSet.calculate_errors"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.ParamSet.calculate_errors">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate positional errors</span>

<span class="sd">        Uses _condon_formulae() if this object is based on a Gaussian fit,</span>
<span class="sd">        _error_bars_from_moments() if it&#39;s based on moments.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_condon_formulae</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">moments</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_bars_from_moments</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">_condon_formulae</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the errors on parameters from Gaussian fits according to</span>
<span class="sd">        the Condon (PASP 109, 166 (1997)) formulae.</span>

<span class="sd">        These formulae are not perfect, but we&#39;ll use them for the</span>
<span class="sd">        time being.  (See Refregier and Brown (astro-ph/9803279v1) for</span>
<span class="sd">        a more rigorous approach.) It also returns the corrected peak.</span>
<span class="sd">        The peak is corrected for the overestimate due to the local</span>
<span class="sd">        noise gradient.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">smaj</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">smin</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="n">theta_B</span><span class="p">,</span> <span class="n">theta_b</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calculate_correlation_lengths</span><span class="p">(</span>
            <span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">rho_sq1</span> <span class="o">=</span> <span class="p">((</span><span class="n">smaj</span><span class="o">*</span><span class="n">smin</span><span class="o">/</span><span class="p">(</span><span class="n">theta_B</span><span class="o">*</span><span class="n">theta_b</span><span class="p">))</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">theta_B</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">smaj</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_maj1</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">theta_b</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">smin</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_min1</span> <span class="o">*</span>
                   <span class="p">(</span><span class="n">peak</span><span class="o">/</span><span class="n">noise</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rho_sq2</span> <span class="o">=</span> <span class="p">((</span><span class="n">smaj</span><span class="o">*</span><span class="n">smin</span><span class="o">/</span><span class="p">(</span><span class="n">theta_B</span><span class="o">*</span><span class="n">theta_b</span><span class="p">))</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">theta_B</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">smaj</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_maj2</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">theta_b</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">smin</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_min2</span> <span class="o">*</span>
                   <span class="p">(</span><span class="n">peak</span><span class="o">/</span><span class="n">noise</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">rho_sq3</span> <span class="o">=</span> <span class="p">((</span><span class="n">smaj</span><span class="o">*</span><span class="n">smin</span><span class="o">/</span><span class="p">(</span><span class="n">theta_B</span><span class="o">*</span><span class="n">theta_b</span><span class="p">))</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">theta_B</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">smaj</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_maj3</span> <span class="o">*</span>
                   <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">theta_b</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">smin</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_min3</span> <span class="o">*</span>
                   <span class="p">(</span><span class="n">peak</span><span class="o">/</span><span class="n">noise</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">rho1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho_sq1</span><span class="p">)</span>
        <span class="n">rho2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho_sq2</span><span class="p">)</span>
        <span class="n">rho3</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho_sq3</span><span class="p">)</span>

        <span class="n">denom1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho1</span>
        <span class="n">denom2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">rho2</span>

        <span class="c"># Here you get the errors parallel to the fitted semi-major and</span>
        <span class="c"># semi-minor axes as taken from the NVSS paper (Condon et al. 1998,</span>
        <span class="c"># AJ, 115, 1693), formula 25.</span>
        <span class="c"># Those variances are twice the theoreticals, so the errors in</span>
        <span class="c"># position are sqrt(2) as large as one would get from formula 21</span>
        <span class="c"># of the Condon (1997) paper.</span>
        <span class="n">error_par_major</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">smaj</span><span class="o">/</span><span class="n">denom1</span>
        <span class="n">error_par_minor</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">smin</span><span class="o">/</span><span class="n">denom2</span>

        <span class="c"># When these errors are converted to RA and Dec,</span>
        <span class="c"># calibration uncertainties will have to be added,</span>
        <span class="c"># like in formulae 27 of the NVSS paper.</span>
        <span class="n">errorx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">error_par_major</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">error_par_minor</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">errory</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">error_par_major</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                            <span class="p">(</span><span class="n">error_par_minor</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c"># Note that we report errors in HWHM axes instead of FWHM axes</span>
        <span class="c"># so the errors are half the errors of formula 29 of the NVSS paper.</span>
        <span class="n">errorsmaj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">smaj</span> <span class="o">/</span> <span class="n">rho1</span>
        <span class="n">errorsmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">smin</span> <span class="o">/</span> <span class="n">rho2</span>

        <span class="k">if</span> <span class="n">smaj</span> <span class="o">&gt;</span> <span class="n">smin</span><span class="p">:</span>
            <span class="n">errortheta</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">smaj</span><span class="o">*</span><span class="n">smin</span><span class="o">/</span><span class="p">(</span><span class="n">smaj</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">smin</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">rho2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errortheta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">errortheta</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="n">errortheta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">peak</span> <span class="o">+=</span> <span class="o">-</span><span class="n">noise</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">peak</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_bias</span>

        <span class="n">errorpeaksq</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_flux_cal_error</span> <span class="o">*</span> <span class="n">peak</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">clean_bias_error</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="mf">2.</span> <span class="o">*</span> <span class="n">peak</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">rho_sq3</span><span class="p">)</span>

        <span class="n">errorpeak</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">errorpeaksq</span><span class="p">)</span>

        <span class="n">help1</span> <span class="o">=</span> <span class="p">(</span><span class="n">errorsmaj</span><span class="o">/</span><span class="n">smaj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">help2</span> <span class="o">=</span> <span class="p">(</span><span class="n">errorsmin</span><span class="o">/</span><span class="n">smin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">help3</span> <span class="o">=</span> <span class="n">theta_B</span> <span class="o">*</span> <span class="n">theta_b</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">smaj</span> <span class="o">*</span> <span class="n">smin</span><span class="p">)</span>
        <span class="n">errorflux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">errorpeaksq</span><span class="o">/</span><span class="n">peak</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">help3</span><span class="o">*</span><span class="p">(</span><span class="n">help1</span><span class="o">+</span><span class="n">help2</span><span class="p">))</span>

        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">errorpeak</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorflux</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;xbar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorx</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;ybar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errory</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorsmaj</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorsmin</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errortheta</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_error_bars_from_moments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide reasonable error estimates from the moments&quot;&quot;&quot;</span>

        <span class="c"># The formulae below should give some reasonable estimate of the</span>
        <span class="c"># errors from moments, should always be higher than the errors from</span>
        <span class="c"># Gauss fitting.</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">smaj</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">smin</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="c"># This analysis is only possible if the peak flux is &gt;= 0. This</span>
        <span class="c"># follows from the definition of eq. 2.81 in Spreeuw&#39;s thesis. In that</span>
        <span class="c"># situation, we set all errors to be infinite</span>
        <span class="k">if</span> <span class="n">peak</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">clean_bias_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_bias_error</span>
        <span class="n">frac_flux_cal_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_flux_cal_error</span>
        <span class="n">theta_B</span><span class="p">,</span> <span class="n">theta_b</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calculate_correlation_lengths</span><span class="p">(</span>
            <span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># This is eq. 2.81 from Spreeuw&#39;s thesis.</span>
        <span class="n">rho_sq</span> <span class="o">=</span> <span class="p">((</span><span class="mf">16.</span> <span class="o">*</span> <span class="n">smaj</span> <span class="o">*</span> <span class="n">smin</span> <span class="o">/</span>
                  <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">theta_B</span> <span class="o">*</span> <span class="n">theta_b</span><span class="o">*</span><span class="n">noise</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                  <span class="o">*</span> <span class="p">((</span><span class="n">peak</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">/</span>
                     <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">threshold</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">rho</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho_sq</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">*</span><span class="n">rho</span>

        <span class="c"># Again, like above for the Condon formulae, we set the</span>
        <span class="c"># positional variances to twice the theoretical values.</span>
        <span class="n">error_par_major</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">smaj</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="n">error_par_minor</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">smin</span> <span class="o">/</span> <span class="n">denom</span>

        <span class="c"># When these errors are converted to RA and Dec,</span>
        <span class="c"># calibration uncertainties will have to be added,</span>
        <span class="c"># like in formulae 27 of the NVSS paper.</span>
        <span class="n">errorx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">error_par_major</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">error_par_minor</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">errory</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">error_par_major</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
                            <span class="o">+</span> <span class="p">(</span><span class="n">error_par_minor</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c"># Note that we report errors in HWHM axes instead of FWHM axes</span>
        <span class="c"># so the errors are half the errors of formula 29 of the NVSS paper.</span>
        <span class="n">errorsmaj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">smaj</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="n">errorsmin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">smin</span> <span class="o">/</span> <span class="n">rho</span>

        <span class="k">if</span> <span class="n">smaj</span> <span class="o">&gt;</span> <span class="n">smin</span><span class="p">:</span>
            <span class="n">errortheta</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">smaj</span> <span class="o">*</span> <span class="n">smin</span> <span class="o">/</span> <span class="p">(</span><span class="n">smaj</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span><span class="n">smin</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errortheta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">if</span> <span class="n">errortheta</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="n">errortheta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

        <span class="c"># The peak from &quot;moments&quot; is just the value of the maximum pixel</span>
        <span class="c"># times a correction, fudge_max_pix, for the fact that the</span>
        <span class="c"># centre of the Gaussian is not at the centre of the pixel.</span>
        <span class="c"># This correction is performed in fitting.py. The maximum pixel</span>
        <span class="c"># method introduces a peak dependent error corresponding to the last</span>
        <span class="c"># term in the expression below for errorpeaksq.</span>
        <span class="c"># To this, we add, in quadrature, the errors corresponding</span>
        <span class="c"># to the first and last term of the rhs of equation 37 of the</span>
        <span class="c"># NVSS paper. The middle term in that equation 37 is heuristically</span>
        <span class="c"># replaced by noise**2 since the threshold should not affect</span>
        <span class="c"># the error from the (corrected) maximum pixel method,</span>
        <span class="c"># while it is part of the expression for rho_sq above.</span>
        <span class="n">errorpeaksq</span> <span class="o">=</span> <span class="p">((</span><span class="n">frac_flux_cal_error</span><span class="o">*</span><span class="n">peak</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="n">clean_bias_error</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">noise</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                       <span class="n">utils</span><span class="o">.</span><span class="n">maximum_pixel_method_variance</span><span class="p">(</span>
            <span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beam</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">peak</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">errorpeak</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">errorpeaksq</span><span class="p">)</span>

        <span class="n">help1</span> <span class="o">=</span> <span class="p">(</span><span class="n">errorsmaj</span><span class="o">/</span><span class="n">smaj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">help2</span> <span class="o">=</span> <span class="p">(</span><span class="n">errorsmin</span><span class="o">/</span><span class="n">smin</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">help3</span> <span class="o">=</span> <span class="n">theta_B</span><span class="o">*</span><span class="n">theta_b</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">smaj</span><span class="o">*</span><span class="n">smin</span><span class="p">)</span>
        <span class="n">errorflux</span> <span class="o">=</span> <span class="n">flux</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">errorpeaksq</span><span class="o">/</span><span class="n">peak</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">help3</span><span class="o">*</span><span class="p">(</span><span class="n">help1</span><span class="o">+</span><span class="n">help2</span><span class="p">))</span>

        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorpeak</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorflux</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;xbar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorx</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;ybar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errory</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorsmaj</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errorsmin</span>
        <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">errortheta</span>

        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="ParamSet.deconvolve_from_clean_beam"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.ParamSet.deconvolve_from_clean_beam">[docs]</a>    <span class="k">def</span> <span class="nf">deconvolve_from_clean_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deconvolve with the clean beam&quot;&quot;&quot;</span>

        <span class="c"># If the fitted axes are smaller than the clean beam</span>
        <span class="c"># (=restoring beam) axes, the axes and position angle</span>
        <span class="c"># can be deconvolved from it.</span>
        <span class="n">fmaj</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">fmajerror</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span>
        <span class="n">fmin</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">fminerror</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span>
        <span class="n">fpa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">fpaerror</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>
        <span class="n">cmaj</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cpa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">beam</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">rmaj</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rpa</span><span class="p">,</span> <span class="n">ierr</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span><span class="n">fmaj</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
        <span class="c"># This parameter gives the number of components that could not be</span>
        <span class="c"># deconvolved, IERR from deconf.f.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deconv_imposs</span> <span class="o">=</span> <span class="n">ierr</span>
        <span class="c"># Now, figure out the error bars.</span>
        <span class="k">if</span> <span class="n">rmaj</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># In this case the deconvolved position angle is defined.</span>
            <span class="c"># For convenience we reset rpa to the interval [-90, 90].</span>
            <span class="k">if</span> <span class="n">rpa</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                <span class="n">rpa</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="o">-</span><span class="n">rpa</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">rpa</span>

            <span class="c"># In the general case, where the restoring beam is elliptic,</span>
            <span class="c"># calculating the error bars of the deconvolved position angle</span>
            <span class="c"># is more complicated than in the NVSS case, where a circular</span>
            <span class="c"># restoring beam was used.</span>
            <span class="c"># In the NVSS case the error bars of the deconvolved angle are</span>
            <span class="c"># equal to the fitted angle.</span>
            <span class="n">rmaj1</span><span class="p">,</span> <span class="n">rmin1</span><span class="p">,</span> <span class="n">rpa1</span><span class="p">,</span> <span class="n">ierr1</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                <span class="n">fmaj</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fpa</span><span class="o">+</span><span class="n">fpaerror</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ierr1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rpa1</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="n">rpa1</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="o">-</span><span class="n">rpa1</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>
                <span class="n">rpaerror1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rpa1</span><span class="o">-</span><span class="n">rpa</span><span class="p">)</span>
                <span class="c"># An angle error can never be more than 90 degrees.</span>
                <span class="k">if</span> <span class="n">rpaerror1</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">:</span>
                    <span class="n">rpaerror1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="o">-</span><span class="n">rpaerror1</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rpaerror1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">rmaj2</span><span class="p">,</span> <span class="n">rmin2</span><span class="p">,</span> <span class="n">rpa2</span><span class="p">,</span> <span class="n">ierr2</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                <span class="n">fmaj</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fpa</span><span class="o">-</span><span class="n">fpaerror</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ierr2</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rpa2</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
                    <span class="n">rpa2</span> <span class="o">=</span> <span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="o">-</span><span class="n">rpa2</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>
                <span class="n">rpaerror2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rpa2</span> <span class="o">-</span> <span class="n">rpa</span><span class="p">)</span>
                <span class="c"># An angle error can never be more than 90 degrees.</span>
                <span class="k">if</span> <span class="n">rpaerror2</span> <span class="o">&gt;</span> <span class="mf">90.</span><span class="p">:</span>
                    <span class="n">rpaerror2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="o">-</span><span class="n">rpaerror2</span><span class="p">,</span> <span class="mf">180.</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rpaerror2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rpaerror1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rpaerror2</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">rpaerror1</span><span class="p">,</span> <span class="n">rpaerror2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">rpaerror1</span><span class="p">,</span> <span class="n">rpaerror2</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">rmaj</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">rmaj3</span><span class="p">,</span> <span class="n">rmin3</span><span class="p">,</span> <span class="n">rpa3</span><span class="p">,</span> <span class="n">ierr3</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                <span class="n">fmaj</span> <span class="o">+</span> <span class="n">fmajerror</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
            <span class="c"># If rmaj&gt;0, then rmaj3 should also be &gt; 0,</span>
            <span class="c"># if I am not mistaken, see the formulas at</span>
            <span class="c"># the end of ch.2 of Spreeuw&#39;s Ph.D. thesis.</span>
            <span class="k">if</span> <span class="n">fmaj</span><span class="o">-</span><span class="n">fmajerror</span> <span class="o">&gt;</span> <span class="n">fmin</span><span class="p">:</span>
                <span class="n">rmaj4</span><span class="p">,</span> <span class="n">rmin4</span><span class="p">,</span> <span class="n">rpa4</span><span class="p">,</span> <span class="n">ierr4</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                    <span class="n">fmaj</span><span class="o">-</span><span class="n">fmajerror</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rmaj4</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmaj3</span><span class="o">-</span><span class="n">rmaj</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmaj</span> <span class="o">-</span> <span class="n">rmaj4</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmaj3</span> <span class="o">-</span> <span class="n">rmaj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rmin4</span><span class="p">,</span> <span class="n">rmaj4</span><span class="p">,</span> <span class="n">rpa4</span><span class="p">,</span> <span class="n">ierr4</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                    <span class="n">fmin</span><span class="p">,</span> <span class="n">fmaj</span> <span class="o">-</span> <span class="n">fmajerror</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rmaj4</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmaj3</span><span class="o">-</span><span class="n">rmaj</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmaj</span> <span class="o">-</span> <span class="n">rmaj4</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmaj3</span> <span class="o">-</span> <span class="n">rmaj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rmin</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimin_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">rmin</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="k">if</span> <span class="n">fmin</span> <span class="o">+</span> <span class="n">fminerror</span> <span class="o">&lt;</span> <span class="n">fmaj</span><span class="p">:</span>
                    <span class="n">rmaj5</span><span class="p">,</span> <span class="n">rmin5</span><span class="p">,</span> <span class="n">rpa5</span><span class="p">,</span> <span class="n">ierr5</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                        <span class="n">fmaj</span><span class="p">,</span> <span class="n">fmin</span><span class="o">+</span><span class="n">fminerror</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rmin5</span><span class="p">,</span> <span class="n">rmaj5</span><span class="p">,</span> <span class="n">rpa5</span><span class="p">,</span> <span class="n">ierr5</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                        <span class="n">fmin</span><span class="o">+</span><span class="n">fminerror</span><span class="p">,</span> <span class="n">fmaj</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
                <span class="c"># If rmin &gt; 0, then rmin5 should also be &gt; 0,</span>
                <span class="c"># if I am not mistaken, see the formulas at</span>
                <span class="c"># the end of ch.2 of Spreeuw&#39;s Ph.D. thesis.</span>
                <span class="n">rmaj6</span><span class="p">,</span> <span class="n">rmin6</span><span class="p">,</span> <span class="n">rpa6</span><span class="p">,</span> <span class="n">ierr6</span> <span class="o">=</span> <span class="n">deconv</span><span class="p">(</span>
                    <span class="n">fmaj</span><span class="p">,</span> <span class="n">fmin</span><span class="o">-</span><span class="n">fminerror</span><span class="p">,</span> <span class="n">fpa</span><span class="p">,</span> <span class="n">cmaj</span><span class="p">,</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">cpa</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rmin6</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimin_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmin6</span><span class="o">-</span><span class="n">rmin</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmin5</span> <span class="o">-</span> <span class="n">rmin</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimin_deconv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rmin5</span> <span class="o">-</span> <span class="n">rmin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimin_deconv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;semimin_deconv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s">&#39;theta_deconv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

</div></div>
<div class="viewcode-block" id="source_profile_and_errors"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.source_profile_and_errors">[docs]</a><span class="k">def</span> <span class="nf">source_profile_and_errors</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">residuals</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a number of measurable properties with errorbars</span>

<span class="sd">    Given an island of pixels it will return a number of measurable</span>
<span class="sd">    properties including errorbars.  It will also compute residuals</span>
<span class="sd">    from Gauss fitting and export these to a residual map.  And it</span>
<span class="sd">    will make a map of the decomposed sources.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (numpy.ndarray): array of pixel values, can be a masked</span>
<span class="sd">            array, which is necessary for proper Gauss fitting,</span>
<span class="sd">            because the pixels below the threshold in the corners and</span>
<span class="sd">            along the edges should not be included in the fitting</span>
<span class="sd">            process</span>

<span class="sd">        threshold (float): Threshold used for selecting pixels for the</span>
<span class="sd">            source (ie, building an island)</span>

<span class="sd">        noise (float): Noise level in data</span>

<span class="sd">        beam (3-tuple of float): beam parameters</span>

<span class="sd">    Kwargs:</span>

<span class="sd">        fixed (dict): parameters to keep fixed while fitting. passed</span>
<span class="sd">            on to fitting.fitgaussian(): this will lock fit to only</span>
<span class="sd">            occur at that pixel coordinate.</span>

<span class="sd">    Returns:</span>

<span class="sd">        (tuple): a populated ParamSet, and a residual array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">fixed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fixed</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">ParamSet</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">moments_threshold</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moments_threshold</span> <span class="o">=</span> <span class="n">threshold</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fitting</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">moments_threshold</span><span class="p">))</span>
        <span class="n">param</span><span class="o">.</span><span class="n">moments</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># If this happens, we have two choices:</span>
        <span class="c"># 1) Bomb out and tell the user to fit something sensible instead;</span>
        <span class="c"># 2) Make up our own estimate (all 1s or something) to give the</span>
        <span class="c"># gaussian fitter a starting point.</span>
        <span class="n">param</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&quot;peak&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">&quot;flux&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">&quot;xbar&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="s">&quot;ybar&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="s">&quot;semimajor&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">&quot;semiminor&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">&quot;theta&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">})</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Unable to estimate gaussian parameters.&quot;</span>
                      <span class="s">&quot; Proceeding with defaults </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>

    <span class="n">ranges</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c"># Now we can do Gauss fitting if the island or subisland has a</span>
        <span class="c"># thickness of more than 2 in both dimensions.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">param</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fitting</span><span class="o">.</span><span class="n">fitgaussian</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">))</span>
            <span class="n">param</span><span class="o">.</span><span class="n">gaussian</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Gauss fitting was successful.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Gauss fitting failed.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fixed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">param</span><span class="o">.</span><span class="n">gaussian</span><span class="p">:</span>
        <span class="c"># moments can&#39;t handle fixed params</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;fit failed with given fixed parameters&quot;</span><span class="p">)</span>

    <span class="n">beamsize</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">calculate_beamsize</span><span class="p">(</span><span class="n">beam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beam</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">param</span><span class="p">[</span><span class="s">&quot;flux&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s">&quot;peak&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">param</span><span class="p">[</span><span class="s">&quot;semimajor&quot;</span><span class="p">]</span> <span class="o">*</span>
                     <span class="n">param</span><span class="p">[</span><span class="s">&quot;semiminor&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">beamsize</span><span class="p">)</span>
    <span class="n">param</span><span class="o">.</span><span class="n">calculate_errors</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">param</span><span class="o">.</span><span class="n">deconvolve_from_clean_beam</span><span class="p">(</span><span class="n">beam</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">residuals</span><span class="p">:</span>
        <span class="n">gauss_arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s">&quot;peak&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">param</span><span class="p">[</span><span class="s">&quot;xbar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">param</span><span class="p">[</span><span class="s">&quot;ybar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">param</span><span class="p">[</span><span class="s">&quot;semimajor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">param</span><span class="p">[</span><span class="s">&quot;semiminor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">param</span><span class="p">[</span><span class="s">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">gauss_resid</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">gaussian</span><span class="p">(</span><span class="o">*</span><span class="n">gauss_arg</span><span class="p">)(</span>
            <span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gauss_resid</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">param</span><span class="p">,</span> <span class="n">gauss_resid</span>

</div>
<div class="viewcode-block" id="Detection"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Detection">[docs]</a><span class="k">class</span> <span class="nc">Detection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The result of a measurement at a given position in a given image.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramset</span><span class="p">,</span> <span class="n">imagedata</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">eps_ra</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">eps_dec</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eps_ra</span> <span class="o">=</span> <span class="n">eps_ra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_dec</span> <span class="o">=</span> <span class="n">eps_dec</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span> <span class="o">=</span> <span class="n">imagedata</span>
        <span class="c">##self.wcs = imagedata.wcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;xbar&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;ybar&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;semimajor&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smin</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;semiminor&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span>
        <span class="c"># This parameter gives the number of components that could not</span>
        <span class="c"># be deconvolved, IERR from deconf.f.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dc_imposs</span> <span class="o">=</span> <span class="n">paramset</span><span class="o">.</span><span class="n">deconv_imposs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smaj_dc</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;semimaj_deconv&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smin_dc</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;semimin_deconv&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_dc</span> <span class="o">=</span> <span class="n">paramset</span><span class="p">[</span><span class="s">&#39;theta_deconv&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_radius</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span> <span class="o">=</span> <span class="n">paramset</span><span class="o">.</span><span class="n">gaussian</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">paramset</span><span class="o">.</span><span class="n">sig</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_coordinates</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Physical coordinates failed at </span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;imagedata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="p">,</span>
            <span class="s">&#39;chunk&#39;</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span><span class="p">),</span>
            <span class="s">&#39;peak&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span>
            <span class="s">&#39;flux&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
            <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="s">&#39;y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
            <span class="s">&#39;smaj&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="p">,</span>
            <span class="s">&#39;smin&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="p">,</span>
            <span class="s">&#39;theta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span>
            <span class="s">&#39;sig&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span>
            <span class="s">&#39;error_radius&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_radius</span><span class="p">,</span>
            <span class="s">&#39;gaussian&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrdict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;imagedata&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;chunk&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;chunk&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                      <span class="nb">slice</span><span class="p">(</span><span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;chunk&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;chunk&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;peak&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;flux&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;y&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;smaj&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smin</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;smin&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;theta&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_radius</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;error_radius&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span> <span class="o">=</span> <span class="n">attrdict</span><span class="p">[</span><span class="s">&#39;gaussian&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_physical_coordinates</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Physical coordinates failed at </span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">):</span>
        <span class="c"># Backwards compatibility for &quot;errquantity&quot; attributes</span>
        <span class="k">if</span> <span class="n">attrname</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;err&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">attrname</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">.</span><span class="n">error</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">attrname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;(</span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">) +/- (</span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">): </span><span class="si">%g</span><span class="s"> +/- </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">error</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">error</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_physical_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the pixel parameters for this object into something</span>
<span class="sd">        physical.&quot;&quot;&quot;</span>

        <span class="c"># First, the RA &amp; dec.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="p">[</span><span class="n">Uncertain</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">p2s</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">])]</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">90.0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;object falls outside the sky&quot;</span><span class="p">)</span>

        <span class="c"># First, determine local north.</span>
        <span class="n">help1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">help2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">help3</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">help4</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="n">center_position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">help3</span><span class="o">*</span><span class="n">help1</span><span class="p">,</span> <span class="n">help3</span><span class="o">*</span><span class="n">help2</span><span class="p">,</span> <span class="n">help4</span><span class="p">])</span>

        <span class="c"># The length of this vector is chosen such that it touches</span>
        <span class="c"># the tangent plane at center position.</span>
        <span class="c"># The cross product of the local north vector and the local east</span>
        <span class="c"># vector will always be aligned with the center_position vector.</span>
        <span class="k">if</span> <span class="n">center_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">local_north_position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">center_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If we are right on the equator (ie dec=0) the division above</span>
            <span class="c"># will blow up: as a workaround, we use something Really Big</span>
            <span class="c"># instead.</span>
            <span class="n">local_north_position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">99e99</span><span class="p">])</span>
        <span class="c"># Next, determine the orientation of the y-axis wrt local north</span>
        <span class="c"># by incrementing y by a small amount and converting that</span>
        <span class="c"># to celestial coordinates. That small increment is conveniently</span>
        <span class="c"># chosen to be an increment of 1 pixel.</span>

        <span class="n">endy_ra</span><span class="p">,</span> <span class="n">endy_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">p2s</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="mf">1.</span><span class="p">])</span>
        <span class="n">help5</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">endy_ra</span><span class="p">))</span>
        <span class="n">help6</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">endy_ra</span><span class="p">))</span>
        <span class="n">help7</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">endy_dec</span><span class="p">))</span>
        <span class="n">help8</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">endy_dec</span><span class="p">))</span>
        <span class="n">endy_position</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">help7</span><span class="o">*</span><span class="n">help5</span><span class="p">,</span> <span class="n">help7</span><span class="o">*</span><span class="n">help6</span><span class="p">,</span> <span class="n">help8</span><span class="p">])</span>

        <span class="c"># Extend the length of endy_position to make it touch the plane</span>
        <span class="c"># tangent at center_position.</span>
        <span class="n">endy_position</span> <span class="o">/=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">center_position</span><span class="p">,</span> <span class="n">endy_position</span><span class="p">)</span>

        <span class="n">diff1</span> <span class="o">=</span> <span class="n">endy_position</span><span class="o">-</span><span class="n">center_position</span>
        <span class="n">diff2</span> <span class="o">=</span> <span class="n">local_north_position</span><span class="o">-</span><span class="n">center_position</span>

        <span class="n">cross_prod</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">diff2</span><span class="p">,</span> <span class="n">diff1</span><span class="p">)</span>

        <span class="n">length_cross_sq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cross_prod</span><span class="p">,</span> <span class="n">cross_prod</span><span class="p">)</span>

        <span class="n">normalization</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diff1</span><span class="p">,</span> <span class="n">diff1</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diff2</span><span class="p">,</span> <span class="n">diff2</span><span class="p">)</span>

        <span class="c"># The length of the cross product equals the product of the lengths of</span>
        <span class="c"># the vectors times the sine of their angle.</span>
        <span class="c"># This is the angle between the y-axis and local north,</span>
        <span class="c"># measured eastwards.</span>
        <span class="c"># yoffset_angle = numpy.degrees(</span>
        <span class="c">#    numpy.arcsin(numpy.sqrt(length_cross_sq/normalization)))</span>
        <span class="c"># The formula above is commented out because the angle computed</span>
        <span class="c"># in this way will always be 0&lt;=yoffset_angle&lt;=90.</span>
        <span class="c"># We&#39;ll use the dotproduct instead.</span>
        <span class="n">yoffs_rad</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span><span class="p">)</span> <span class="o">/</span>
                                  <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normalization</span><span class="p">)))</span>

        <span class="c"># The multiplication with -sign_cor makes sure that the angle</span>
        <span class="c"># is measured eastwards (increasing RA), not westwards.</span>
        <span class="n">sign_cor</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cross_prod</span><span class="p">,</span> <span class="n">center_position</span><span class="p">)</span> <span class="o">/</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">length_cross_sq</span><span class="p">))</span>
        <span class="n">yoffs_rad</span> <span class="o">*=</span> <span class="o">-</span><span class="n">sign_cor</span>
        <span class="n">yoffset_angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">yoffs_rad</span><span class="p">)</span>

        <span class="c"># Now that we have the BPA, we can also compute the position errors</span>
        <span class="c"># properly, by projecting the errors in pixel coordinates (x and y)</span>
        <span class="c"># on local north and local east.</span>
        <span class="n">errorx_proj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">yoffs_rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">error</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">yoffs_rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">errory_proj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">yoffs_rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">error</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">yoffs_rad</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c"># Now we have to sort out which combination of errorx_proj and</span>
        <span class="c"># errory_proj gives the largest errors in RA and Dec.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">end_ra1</span><span class="p">,</span> <span class="n">end_dec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">p2s</span><span class="p">(</span>
                                       <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="n">errorx_proj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
            <span class="n">end_ra2</span><span class="p">,</span> <span class="n">end_dec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">p2s</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="o">+</span><span class="n">errory_proj</span><span class="p">])</span>
            <span class="c"># Here we include the position calibration errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_ra</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">end_ra1</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">end_ra2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps_dec</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">end_dec1</span><span class="p">),</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">end_dec2</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="c">#We get a runtime error from wcs.p2s if the errors place the</span>
            <span class="c">#limits outside of the image.</span>
            <span class="c">#In which case we set the RA / DEC uncertainties to infinity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;inf&#39;</span><span class="p">)</span>

        <span class="c"># Estimate an absolute angular error on our central position.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_radius</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_error_radius</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">error</span>
        <span class="p">)</span>

        <span class="c"># Now we can compute the BPA, east from local north.</span>
        <span class="c"># That these angles can simply be added is not completely trivial.</span>
        <span class="c"># First, the Gaussian in gaussian.py must be such that theta is</span>
        <span class="c"># measured from the positive y-axis in the direction of negative x.</span>
        <span class="c"># Secondly, x and y are defined such that the direction</span>
        <span class="c"># positive y--&gt;negative x--&gt;negative y--&gt;positive x is the same</span>
        <span class="c"># direction (counterclockwise) as (local) north--&gt;east--&gt;south--&gt;west.</span>
        <span class="c"># If these two conditions are matched, the formula below is valid.</span>
        <span class="c"># Of course, the formula is also valid if theta is measured</span>
        <span class="c"># from the positive y-axis towards positive x</span>
        <span class="c"># and both of these directions are equal (clockwise).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_celes</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span>
            <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">yoffset_angle</span><span class="p">)</span> <span class="o">%</span> <span class="mi">180</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta_dc_celes</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_dc</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">yoffset_angle</span><span class="p">)</span> <span class="o">%</span> <span class="mi">180</span><span class="p">,</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_dc</span><span class="o">.</span><span class="n">error</span><span class="p">))</span>

        <span class="c"># Next, the axes.</span>
        <span class="c"># Note that the signs of numpy.sin and numpy.cos in the</span>
        <span class="c"># four expressions below are arbitrary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_smaj_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_smaj_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_smaj_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_smaj_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_smin_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_smin_x</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_smin_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_smin_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">pixel_to_spatial</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagedata</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">p2s</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;pixel_to_spatial failed at </span><span class="si">%f</span><span class="s">, </span><span class="si">%f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">end_smaj_ra</span><span class="p">,</span> <span class="n">end_smaj_dec</span> <span class="o">=</span> <span class="n">pixel_to_spatial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_smaj_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_smaj_y</span><span class="p">)</span>
        <span class="n">end_smin_ra</span><span class="p">,</span> <span class="n">end_smin_dec</span> <span class="o">=</span> <span class="n">pixel_to_spatial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_smin_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_smin_y</span><span class="p">)</span>

        <span class="n">smaj_asec</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">angsep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">end_smaj_ra</span><span class="p">,</span> <span class="n">end_smaj_dec</span><span class="p">)</span>
        <span class="n">scaling_smaj</span> <span class="o">=</span> <span class="n">smaj_asec</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="o">.</span><span class="n">value</span>
        <span class="n">errsmaj_asec</span> <span class="o">=</span> <span class="n">scaling_smaj</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smaj</span><span class="o">.</span><span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smaj_asec</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span><span class="n">smaj_asec</span><span class="p">,</span> <span class="n">errsmaj_asec</span><span class="p">)</span>

        <span class="n">smin_asec</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">angsep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                       <span class="n">end_smin_ra</span><span class="p">,</span> <span class="n">end_smin_dec</span><span class="p">)</span>
        <span class="n">scaling_smin</span> <span class="o">=</span> <span class="n">smin_asec</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="o">.</span><span class="n">value</span>
        <span class="n">errsmin_asec</span> <span class="o">=</span> <span class="n">scaling_smin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">smin</span><span class="o">.</span><span class="n">error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smin_asec</span> <span class="o">=</span> <span class="n">Uncertain</span><span class="p">(</span><span class="n">smin_asec</span><span class="p">,</span> <span class="n">errsmin_asec</span><span class="p">)</span>

<div class="viewcode-block" id="Detection.distance_from"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Detection.distance_from">[docs]</a>    <span class="k">def</span> <span class="nf">distance_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Distance from center&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
</div>
<div class="viewcode-block" id="Detection.serialize"><a class="viewcode-back" href="../../../devref/tkp/sourcefinder/extract.html#tkp.sourcefinder.extract.Detection.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ew_sys_err</span><span class="p">,</span> <span class="n">ns_sys_err</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return source properties suitable for database storage.</span>

<span class="sd">        We manually add ew_sys_err, ns_sys_err</span>

<span class="sd">        returns: a list of tuples containing all relevant fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># MonetDB doesn&#39;t recognize numpy.float64 values, so</span>
        <span class="c"># in order to let the database accept the values, we convert them</span>
        <span class="c"># to float</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">error</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">error</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">error</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">error</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smaj_asec</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smin_asec</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_celes</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">ew_sys_err</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">ns_sys_err</span><span class="p">),</span>
            <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_radius</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gaussian</span>
        <span class="p">]</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/lofar.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">LOFAR Transients Pipeline 2.0-pre documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 20062014, LOFAR Transients Key Science Project.
    </div>
  </body>
</html>